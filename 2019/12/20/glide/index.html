<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />



  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">






  <meta name="keywords" content="Glide," />










<meta name="description" content="这篇图、文、表、代码一起组成的Glide源码分析。这篇Glide的代码分析量可以说至少是ImageLoader的3倍多，本来想对Glide代码进行拆分，细化每个部分进行讲解这个每个部分讲的更加清楚一些。但最终还是打算整体一篇文章讲完，因为我觉得整体性的学习能更深的的了解到Glide的框架的设计之美。阅读本文需要大量的时间，最好选择对应的目录进行逐步阅读。">
<meta name="keywords" content="Glide">
<meta property="og:type" content="article">
<meta property="og:title" content="Glide源码阅读理解一小时">
<meta property="og:url" content="http://yoursite.com/2019/12/20/glide/index.html">
<meta property="og:site_name" content="下雨天要逛街">
<meta property="og:description" content="这篇图、文、表、代码一起组成的Glide源码分析。这篇Glide的代码分析量可以说至少是ImageLoader的3倍多，本来想对Glide代码进行拆分，细化每个部分进行讲解这个每个部分讲的更加清楚一些。但最终还是打算整体一篇文章讲完，因为我觉得整体性的学习能更深的的了解到Glide的框架的设计之美。阅读本文需要大量的时间，最好选择对应的目录进行逐步阅读。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20191220185346375.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9kYW5kYW5sb3ZlLmJsb2cuY3Nkbi5uZXQ=,size_16,color_FFFFFF,t_70#pic_center">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20191220185627504.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9kYW5kYW5sb3ZlLmJsb2cuY3Nkbi5uZXQ=,size_16,color_FFFFFF,t_70#pic_center">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20191220185656297.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9kYW5kYW5sb3ZlLmJsb2cuY3Nkbi5uZXQ=,size_16,color_FFFFFF,t_70#pic_center">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20191220185718404.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9kYW5kYW5sb3ZlLmJsb2cuY3Nkbi5uZXQ=,size_16,color_FFFFFF,t_70#pic_center">
<meta property="og:image" content="https://img-blog.csdnimg.cn/201912201901022.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9kYW5kYW5sb3ZlLmJsb2cuY3Nkbi5uZXQ=,size_16,color_FFFFFF,t_70#pic_center">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20191220190409636.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9kYW5kYW5sb3ZlLmJsb2cuY3Nkbi5uZXQ=,size_16,color_FFFFFF,t_70#pic_center">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20191220192134589.png#pic_center">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1319879-612c4c66d40ce855.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:updated_time" content="2019-12-27T01:02:16.246Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Glide源码阅读理解一小时">
<meta name="twitter:description" content="这篇图、文、表、代码一起组成的Glide源码分析。这篇Glide的代码分析量可以说至少是ImageLoader的3倍多，本来想对Glide代码进行拆分，细化每个部分进行讲解这个每个部分讲的更加清楚一些。但最终还是打算整体一篇文章讲完，因为我觉得整体性的学习能更深的的了解到Glide的框架的设计之美。阅读本文需要大量的时间，最好选择对应的目录进行逐步阅读。">
<meta name="twitter:image" content="https://img-blog.csdnimg.cn/20191220185346375.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9kYW5kYW5sb3ZlLmJsb2cuY3Nkbi5uZXQ=,size_16,color_FFFFFF,t_70#pic_center">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/12/20/glide/"/>





  <title>Glide源码阅读理解一小时 | 下雨天要逛街</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?1055a4e1d37a3a4dcb3a3e1c4f32f147";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-right page-post-detail">
    <div class="headband"></div>
    <a href="https://github.com/stven0king" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">下雨天要逛街</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/20/glide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="振兴">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/jay.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="下雨天要逛街">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Glide源码阅读理解一小时</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-12-20T19:35:00+08:00">
                2019-12-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          
              <div class="post-description">
                  这篇图、文、表、代码一起组成的Glide源码分析。这篇Glide的代码分析量可以说至少是ImageLoader的3倍多，本来想对Glide代码进行拆分，细化每个部分进行讲解这个每个部分讲的更加清楚一些。但最终还是打算整体一篇文章讲完，因为我觉得整体性的学习能更深的的了解到Glide的框架的设计之美。阅读本文需要大量的时间，最好选择对应的目录进行逐步阅读。 
              </div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这篇<strong>图、文、表、代码</strong>一起组成的 <code>Glide</code> 源码分析的文章是在上一篇文章 <a href="https://dandanlove.blog.csdn.net/article/details/103256724" target="_blank" rel="noopener">Android-Universal-Image-Loader源码分析</a> 中之后的又一篇图片加载框架源码解析，它也具备了 <code>ImageLoader</code> 中讲述了<code>Android</code>一个图片加载库所需要的一些基础必备的：<code>MemoryCahce</code>、<code>DiskCahce</code> <code>Decoder</code> <code>DownLoader</code> 和<code>Executor</code> 等部分。这篇 <code>Glide</code>  的代码分析量可以说至少是 <code>ImageLoader</code> 的3倍多，本来想对 <code>Glide</code> 代码进行拆分，细化每个部分进行讲解这个每个部分讲的更加清楚一些。但最终还是打算整体一篇文章讲完，因为我觉得整体性的学习能更深的的了解到 <code>Glide</code> 的框架的设计之美。</p>
<blockquote>
<p>本篇文章讲述的<code>Glide</code> 相关知识比较多，阅读完需要大量的时间。所以我们按需分配，根据目录寻找自己需要的知识点进行查看。</p>
</blockquote>
<h1 id="Glide介绍"><a href="#Glide介绍" class="headerlink" title="Glide介绍"></a>Glide介绍</h1><p><a href="https://github.com/bumptech/glide" target="_blank" rel="noopener">Glide的Git地址：https://github.com/bumptech/glide</a></p>
<p><a href="https://muyangmin.github.io/glide-docs-cn/" target="_blank" rel="noopener">简体中文文档：https://muyangmin.github.io/glide-docs-cn/</a></p>
<p><a href="https://bumptech.github.io/glide/" target="_blank" rel="noopener">Glide’s documentation：https://bumptech.github.io/glide/</a></p>
<h2 id="关于Glide"><a href="#关于Glide" class="headerlink" title="关于Glide"></a>关于Glide</h2><p><code>Glide</code>是一个快速高效的<code>Android</code>图片加载库，注重于平滑的滚动。<code>Glide</code>提供了易用的<code>API</code>，高性能、可扩展的图片解码管道（<code>decode pipeline</code>），以及自动的资源池技术。</p>
<p><code>Glide</code> 支持拉取，解码和展示视频快照，图片，和GIF动画。<code>Glide</code>的Api是如此的灵活，开发者甚至可以插入和替换成自己喜爱的任何网络栈。默认情况下，<code>Glide</code>使用的是一个定制化的基于<code>HttpUrlConnection</code>的栈，但同时也提供了与<code>Google Volley</code>和<code>Square OkHttp</code>快速集成的工具库。</p>
<p>虽然<code>Glide</code> 的主要目标是让任何形式的图片列表的滚动尽可能地变得更快、更平滑，但实际上，<code>Glide</code>几乎能满足你对远程图片的拉取/缩放/显示的一切需求。</p>
<h2 id="Glide性能"><a href="#Glide性能" class="headerlink" title="Glide性能"></a>Glide性能</h2><p><code>Glide</code> 充分考虑了<code>Android</code>图片加载性能的两个关键方面：</p>
<ul>
<li>图片解码速度</li>
<li>解码图片带来的资源压力</li>
</ul>
<p>为了让用户拥有良好的App使用体验，图片不仅要快速加载，而且还不能因为过多的主线程I/O或频繁的垃圾回收导致页面的闪烁和抖动现象。</p>
<p><code>Glide</code>使用了多个步骤来确保在<code>Android</code>上加载图片尽可能的快速和平滑：</p>
<ul>
<li>自动、智能地下采样(<code>downsampling</code>)和缓存(<code>caching</code>)，以最小化存储开销和解码次数；</li>
<li>积极的资源重用，例如字节数组和<code>Bitmap</code>，以最小化昂贵的垃圾回收和堆碎片影响；</li>
<li>深度的生命周期集成，以确保仅优先处理活跃的<code>Fragment</code>和<code>Activity</code>的请求，并有利于应用在必要时释放资源以避免在后台时被杀掉。</li>
</ul>
<h2 id="GlideAPI"><a href="#GlideAPI" class="headerlink" title="GlideAPI"></a>GlideAPI</h2><p>Glide 使用简明的流式语法API，这是一个非常棒的设计，因为它允许你在大部分情况下一行代码搞定需求：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Glide.with(fragment)</span><br><span class="line">    .load(url)</span><br><span class="line">    .into(imageView);</span><br></pre></td></tr></table></figure>
<p>上述是<code>Fragmeng</code>中<code>Glide</code>将一张网络图片显示到<code>ImageView</code>的代码，下面源码分析的时候我们也会用这段代码进行分析，看看这么简单的<code>API</code>到底是怎么实现的。</p>
<h1 id="Glide源码分析"><a href="#Glide源码分析" class="headerlink" title="Glide源码分析"></a>Glide源码分析</h1><p>我们学习和了解一些框架主要不是看它某个功能的具体实现，主要是学习框架结构搭建和框架中模块的设计与实现。当然每个人的对每个框架的理解都各不相同，不过没关系我们可以多学习多总结，慢慢培养我们自己的框架结构意识。这个在我们平时开发过程中对我们帮助非常大。</p>
<center><img src="https://img-blog.csdnimg.cn/20191220185346375.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9kYW5kYW5sb3ZlLmJsb2cuY3Nkbi5uZXQ=,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></center>

<p>上图是对我<code>Glide</code>的一个总结。</p>
<h2 id="Glide接入"><a href="#Glide接入" class="headerlink" title="Glide接入"></a>Glide接入</h2><p><code>Glide</code>的用法网上有很多文章讲述的都非常好，这里不再进行讲述。这块主要想通过<code>Glide</code>的配置来分析<code>Glide</code>的运行机制。</p>
<p>我们在使用<code>Glide</code>的时候都会使用注解<code>@GlideModule</code> 实现<code>AppGlideModule</code> 或者 <code>GeneratedAppGlideModule</code> ，生成一个类名为<code>GeneratedAppGlideModuleImpl</code> 它是<code>Glide</code> 模块的代理。 在<code>GeneratedAppGlideModuleImpl</code> 会包含我们自定义的<code>GlideModel</code>。</p>
<p>下面为我们接入项目的<code>Glide</code>配置：</p>
<blockquote>
<p>实现Glide对缓存的配置</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GlideModule</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">GlideModuleConfig</span> <span class="keyword">extends</span> <span class="title">AppGlideModule</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">applyOptions</span><span class="params">(@NonNull Context context, @NonNull GlideBuilder builder)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.applyOptions(context, builder);</span><br><span class="line">        <span class="keyword">long</span> memoryCacheSizeBytes = <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">20</span>;</span><br><span class="line">        builder.setMemoryCache(<span class="keyword">new</span> LruResourceCache(memoryCacheSizeBytes));</span><br><span class="line">        <span class="keyword">long</span> diskCacheSizeBytes = <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">100</span>;</span><br><span class="line">        builder.setDiskCache(<span class="keyword">new</span> InternalCacheDiskCacheFactory(context, diskCacheSizeBytes));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>实现Okhttp的接入</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GlideModule</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">OkHttpLibraryGlideModule</span> <span class="keyword">extends</span> <span class="title">LibraryGlideModule</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerComponents</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            @NonNull Context context, @NonNull Glide glide, @NonNull Registry registry)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//将GlideUrl数据转为InputStream的ModelLoader替换为Okhttp</span></span><br><span class="line">        registry.replace(GlideUrl.class, InputStream.class, <span class="keyword">new</span> OkHttpUrlLoader.Factory());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们编译之后生成的<code>GeneratedAppGlideModuleImpl</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">GeneratedAppGlideModuleImpl</span> <span class="keyword">extends</span> <span class="title">GeneratedAppGlideModule</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GlideModuleConfig appGlideModule;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GeneratedAppGlideModuleImpl</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">      appGlideModule = <span class="keyword">new</span> GlideModuleConfig();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//GlideBuilder的配置项进行应用</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">applyOptions</span><span class="params">(@NonNull Context context, @NonNull GlideBuilder builder)</span> </span>&#123;</span><br><span class="line">      appGlideModule.applyOptions(context, builder);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//注册自定义GlideModule</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerComponents</span><span class="params">(@NonNull Context context, @NonNull Glide glide,</span></span></span><br><span class="line"><span class="function"><span class="params">        @NonNull Registry registry)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">new</span> OkHttpLibraryGlideModule().registerComponents(context, glide, registry);</span><br><span class="line">      appGlideModule.registerComponents(context, glide, registry);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/***部分代码省略***/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面将<code>GeneratedAppGlideModuleImpl</code>的使用。</p>
<h2 id="Glide初始化"><a href="#Glide初始化" class="headerlink" title="Glide初始化"></a>Glide初始化</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Glide</span> <span class="keyword">implements</span> <span class="title">ComponentCallbacks2</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Get the singleton.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> the singleton</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Glide <span class="title">get</span><span class="params">(@NonNull Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (glide == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            GeneratedAppGlideModule annotationGeneratedModule = </span><br><span class="line">                getAnnotationGeneratedGlideModules(context.getApplicationContext());</span><br><span class="line">            <span class="keyword">synchronized</span> (Glide.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (glide == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    checkAndInitializeGlide(context, annotationGeneratedModule);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> glide;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//通过Java反射机制获取通过注解生成的GeneratedAppGlideModuleImpl</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> GeneratedAppGlideModule <span class="title">getAnnotationGeneratedGlideModules</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        GeneratedAppGlideModule result = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        Class&lt;GeneratedAppGlideModule&gt; clazz =</span><br><span class="line">            (Class&lt;GeneratedAppGlideModule&gt;)</span><br><span class="line">                Class.forName(<span class="string">"com.bumptech.glide.GeneratedAppGlideModuleImpl"</span>);</span><br><span class="line">        result =</span><br><span class="line">            clazz.getDeclaredConstructor(Context.class).newInstance(context.getApplicationContext());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">        <span class="comment">/***部分代码省略**/</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Glide</code>是个单例，初始化的时候需要注解生成的<code>GeneratedAppGlideModuleImpl</code> 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Glide</span> <span class="keyword">implements</span> <span class="title">ComponentCallbacks2</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GuardedBy</span>(<span class="string">"Glide.class"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initializeGlide</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        @NonNull Context context, @Nullable GeneratedAppGlideModule generatedAppGlideModule)</span> </span>&#123;</span><br><span class="line">        initializeGlide(context, <span class="keyword">new</span> GlideBuilder(), generatedAppGlideModule);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GuardedBy</span>(<span class="string">"Glide.class"</span>)</span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"deprecation"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initializeGlide</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        @NonNull Context context,</span></span></span><br><span class="line"><span class="function"><span class="params">        @NonNull GlideBuilder builder,</span></span></span><br><span class="line"><span class="function"><span class="params">        @Nullable GeneratedAppGlideModule annotationGeneratedModule)</span> </span>&#123;</span><br><span class="line">        Context applicationContext = context.getApplicationContext();</span><br><span class="line">        List&lt;com.bumptech.glide.<span class="keyword">module</span>.GlideModule&gt; manifestModules = Collections.emptyList();</span><br><span class="line">        <span class="comment">//如果Manifest文件中配置了GlideModule，并且annotationGeneratedModule允许Manifest文件中配置生效，那么需要解析出来</span></span><br><span class="line">        <span class="keyword">if</span> (annotationGeneratedModule == <span class="keyword">null</span> || annotationGeneratedModule.isManifestParsingEnabled()) &#123;</span><br><span class="line">            manifestModules = <span class="keyword">new</span> ManifestParser(applicationContext).parse();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果annotationGeneratedModule配置了扩展模块需要解析出来，并且不能与果Manifest中的重复</span></span><br><span class="line">        <span class="keyword">if</span> (annotationGeneratedModule != <span class="keyword">null</span></span><br><span class="line">            &amp;&amp; !annotationGeneratedModule.getExcludedModuleClasses().isEmpty()) &#123;</span><br><span class="line">            Set&lt;Class&lt;?&gt;&gt; excludedModuleClasses = annotationGeneratedModule.getExcludedModuleClasses();</span><br><span class="line">            Iterator&lt;com.bumptech.glide.<span class="keyword">module</span>.GlideModule&gt; iterator = manifestModules.iterator();</span><br><span class="line">            <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                com.bumptech.glide.<span class="keyword">module</span>.GlideModule current = iterator.next();</span><br><span class="line">                <span class="keyword">if</span> (!excludedModuleClasses.contains(current.getClass())) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">/***省略部分日志***/</span></span><br><span class="line">                iterator.remove();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/***省略部分日志***/</span></span><br><span class="line">        <span class="comment">//获取Request的构造管理工厂类</span></span><br><span class="line">        RequestManagerRetriever.RequestManagerFactory factory =</span><br><span class="line">            annotationGeneratedModule != <span class="keyword">null</span></span><br><span class="line">                ? annotationGeneratedModule.getRequestManagerFactory()</span><br><span class="line">                : <span class="keyword">null</span>;</span><br><span class="line">        builder.setRequestManagerFactory(factory);</span><br><span class="line">        <span class="comment">//Manifest中的配置项进行应用</span></span><br><span class="line">        <span class="keyword">for</span> (com.bumptech.glide.<span class="keyword">module</span>.GlideModule <span class="keyword">module</span> : manifestModules) &#123;</span><br><span class="line">            <span class="keyword">module</span>.applyOptions(applicationContext, builder);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//annotationGeneratedModule进行配置项的应用</span></span><br><span class="line">        <span class="keyword">if</span> (annotationGeneratedModule != <span class="keyword">null</span>) &#123;</span><br><span class="line">            annotationGeneratedModule.applyOptions(applicationContext, builder);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//构造Glide</span></span><br><span class="line">        Glide glide = builder.build(applicationContext);</span><br><span class="line">        <span class="comment">//Manifest中的组件进行注册</span></span><br><span class="line">        <span class="keyword">for</span> (com.bumptech.glide.<span class="keyword">module</span>.GlideModule <span class="keyword">module</span> : manifestModules) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">module</span>.registerComponents(applicationContext, glide, glide.registry);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (AbstractMethodError e) &#123;</span><br><span class="line">                <span class="comment">/***省略部分日志***/</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//annotationGeneratedModule中的组件进行注册</span></span><br><span class="line">        <span class="keyword">if</span> (annotationGeneratedModule != <span class="keyword">null</span>) &#123;</span><br><span class="line">            annotationGeneratedModule.registerComponents(applicationContext, glide, glide.registry);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//application注册Glide组件</span></span><br><span class="line">        applicationContext.registerComponentCallbacks(glide);</span><br><span class="line">        Glide.glide = glide;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>获取<code>Manifest</code>的<code>GlideModule</code>，反射构造；</li>
<li>获取<code>GeneratedAppGlideModule</code>中扩展模块，如果包含<code>Manifest</code>的扩展那么进行删除；</li>
<li>获取<code>RequestManagerFactroy</code>;</li>
<li><code>Manifest.applyoptions</code>;</li>
<li><code>GeneratedAppGlideModule.applytions</code>;</li>
<li>构建<code>Glide</code>;</li>
<li><code>Manifest.registerComponents</code>;</li>
<li><code>GeneratedAppGlideModule.registerComponents</code>;</li>
</ol>
<h2 id="Glide和Engine构造"><a href="#Glide和Engine构造" class="headerlink" title="Glide和Engine构造"></a>Glide和Engine构造</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Glide</span> <span class="keyword">implements</span> <span class="title">ComponentCallbacks2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Engine engine;<span class="comment">//负责启动负载以及管理活动和缓存的资源。</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BitmapPool bitmapPool;<span class="comment">//Bitmap的缓存池（LruBitmapPool）</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MemoryCache memoryCache;<span class="comment">//Resource缓存池（LruResourceCache）</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GlideContext glideContext;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Registry registry;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayPool arrayPool;<span class="comment">//存储大小可变的数组的缓存池(LruArrayPool)</span></span><br><span class="line">    <span class="comment">//一组静态方法用来创建一个新的RequestManager或者从已经存在的activity和fragment中获取</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RequestManagerRetriever requestManagerRetriever;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConnectivityMonitorFactory connectivityMonitorFactory;</span><br><span class="line">    <span class="keyword">new</span> Glide(</span><br><span class="line">        <span class="meta">@NonNull</span> context,<span class="comment">//上下文环境</span></span><br><span class="line">        <span class="meta">@NonNull</span> engine,<span class="comment">//任务执行引擎</span></span><br><span class="line">        <span class="meta">@NonNull</span> memoryCache,<span class="comment">//内存资源缓存</span></span><br><span class="line">        <span class="meta">@NonNull</span> bitmapPool,<span class="comment">//内存Bitmap缓存</span></span><br><span class="line">        <span class="meta">@NonNull</span> arrayPool,<span class="comment">//数据缓存池</span></span><br><span class="line">        <span class="meta">@NonNull</span> requestManagerRetriever,<span class="comment">//RequestManager管理集合</span></span><br><span class="line">        <span class="meta">@NonNull</span> connectivityMonitorFactory,<span class="comment">//网络监听器的生产工厂</span></span><br><span class="line">        <span class="keyword">int</span> logLevel,<span class="comment">//log日志等级，默认为Log.info=4</span></span><br><span class="line">        <span class="meta">@NonNull</span> defaultRequestOptionsFactory,<span class="comment">//默认的RequestOptions生产工厂</span></span><br><span class="line">        <span class="meta">@NonNull</span> defaultTransitionOptions,<span class="comment">//默认的资源展现过渡配置容器，，默认map大小为0</span></span><br><span class="line">        <span class="meta">@NonNull</span> defaultRequestListeners,<span class="comment">//在图像加载时的监听器数组，默认数组大小为0</span></span><br><span class="line">        <span class="keyword">boolean</span> isLoggingRequestOriginsEnabled,<span class="comment">//是否需要请求日志</span></span><br><span class="line">        <span class="keyword">boolean</span> isImageDecoderEnabledForBitmaps,<span class="comment">//在安卓P或更高版本进行解码bitmap</span></span><br><span class="line">        <span class="keyword">int</span> hardwareBitmapFdLimit,<span class="comment">//700,</span></span><br><span class="line">        <span class="keyword">int</span> minHardwareDimension)&#123;<span class="comment">//128,</span></span><br><span class="line">        <span class="comment">/***部分代码省略***/</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Glide</code>构造的时候需要构造<code>Engine</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Engine</span></span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">EngineJobListener</span>,</span></span><br><span class="line"><span class="class">        <span class="title">MemoryCache</span>.<span class="title">ResourceRemovedListener</span>,</span></span><br><span class="line"><span class="class">        <span class="title">EngineResource</span>.<span class="title">ResourceListener</span> </span>&#123;</span><br><span class="line">    <span class="comment">/***部分代码省略***/</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Engine</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        MemoryCache memoryCache,//内存缓存</span></span></span><br><span class="line"><span class="function"><span class="params">        DiskCache.Factory diskCacheFactory,//磁盘缓存</span></span></span><br><span class="line"><span class="function"><span class="params">        //磁盘缓存执行器，该线程池的核心线程数和最大线程数为<span class="number">1</span></span></span></span><br><span class="line"><span class="function"><span class="params">        GlideExecutor diskCacheExecutor,</span></span></span><br><span class="line"><span class="function"><span class="params">        //检索资源尚未在缓存中，该线程池的核心线程数和最大线程数为cpu内核数量，最大为<span class="number">4</span></span></span></span><br><span class="line"><span class="function"><span class="params">        GlideExecutor sourceExecutor,</span></span></span><br><span class="line"><span class="function"><span class="params">        ////newScheduledThreadPool，核心线程数为<span class="number">0</span>，用来执行网络操作</span></span></span><br><span class="line"><span class="function"><span class="params">        GlideExecutor sourceUnlimitedExecutor,</span></span></span><br><span class="line"><span class="function"><span class="params">        //加载动画线程池，加载动画图像的帧时使用，尤其是GitDrawable，该线程池的核心线程数和最大线程数为<span class="number">1</span>或<span class="number">2</span>（cpu内核数量&gt;=<span class="number">4</span>）</span></span></span><br><span class="line"><span class="function"><span class="params">        GlideExecutor animationExecutor,</span></span></span><br><span class="line"><span class="function"><span class="params">        //活动资源是否允许被保留，默认为<span class="keyword">false</span></span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> isActiveResourceRetentionAllowed)</span> </span>&#123;</span><br><span class="line">            <span class="comment">/***部分代码省略***/</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/***部分代码省略***/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在阅读源码的时候<code>Glide.java</code>的构造方法，除过基础的赋值操作之前就剩下大量的注册。注册的所有组件都由<code>Registry</code>进行管理。</p>
<h2 id="Register"><a href="#Register" class="headerlink" title="Register"></a>Register</h2><blockquote>
<p><code>Register</code> ：管理组件注册以扩展或替换<code>Glide</code>的默认加载，解码和编码逻辑。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Registry</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BUCKET_GIF = <span class="string">"Gif"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BUCKET_BITMAP = <span class="string">"Bitmap"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BUCKET_BITMAP_DRAWABLE = <span class="string">"BitmapDrawable"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String BUCKET_PREPEND_ALL = <span class="string">"legacy_prepend_all"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String BUCKET_APPEND_ALL = <span class="string">"legacy_append"</span>;</span><br><span class="line">    <span class="comment">//维护&#123;@link ModelLoader&#125;的有序放置以及它们处理的模型和数据类型,从最高优先级到最低优先级的顺序。</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ModelLoaderRegistry modelLoaderRegistry;</span><br><span class="line">    <span class="comment">//编码数据容器，有序列表</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EncoderRegistry encoderRegistry;</span><br><span class="line">    <span class="comment">//包含能够解码任意数据类型的&#123;@link ResourceDecoder&#125;的有序列表</span></span><br><span class="line">    <span class="comment">//分为从最高优先级解码器到最低优先级解码器的任意资源类型。</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ResourceDecoderRegistry decoderRegistry;</span><br><span class="line">    <span class="comment">//包含能够编码任意资源*类型的&#123;@link ResourceEncoder&#125;的有序列表。</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ResourceEncoderRegistry resourceEncoderRegistry;</span><br><span class="line">    <span class="comment">//DataRewinder的生产工厂</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DataRewinderRegistry dataRewinderRegistry;</span><br><span class="line">    <span class="comment">//注册和转化ResourceTranscoder</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TranscoderRegistry transcoderRegistry;</span><br><span class="line">    <span class="comment">//包含能够解析图像标题的&#123;@link ImageHeaderParser&#125;的无序列表。</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ImageHeaderParserRegistry imageHeaderParserRegistry;</span><br><span class="line">    <span class="comment">//维护“模型+资源”类的高速缓存到一组已注册资源类的集合，这些资源类是可以从模型类中解码的资源类的子类。</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ModelToResourceClassCache modelToResourceClassCache = <span class="keyword">new</span> ModelToResourceClassCache();</span><br><span class="line">    <span class="comment">//维护数据，资源和转码类的缓存</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LoadPathCache loadPathCache = <span class="keyword">new</span> LoadPathCache();</span><br><span class="line">    <span class="comment">//异常列表维护容器</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Pool&lt;List&lt;Throwable&gt;&gt; throwableListPool = FactoryPools.threadSafeList();</span><br><span class="line">    <span class="comment">/***部分代码省略***/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面我们看看<code>Glide</code>默认注册的各种组件。</p>
<h3 id="Encoder"><a href="#Encoder" class="headerlink" title="Encoder"></a>Encoder</h3><p><strong>Encoder</strong>：用于将数据编码成文件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//用于将数据写入某些持久性数据存储的接口，例如文件</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Encoder</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">//将给定数据写入给定输出流，如果写入完成，则返回True</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">encode</span><span class="params">(@NonNull T data, @NonNull File file, @NonNull Options options)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>EncoderRegistry</code> ：包含能够编码任意数据类型的<code>Encoder</code>的有序列表。</p>
</blockquote>
<table>
<thead>
<tr>
<th>DataClass</th>
<th>Encoder</th>
</tr>
</thead>
<tbody>
<tr>
<td>ByteBuffer</td>
<td>ByteBufferEncoder</td>
</tr>
<tr>
<td>InputStream</td>
<td>StreamEncoder</td>
</tr>
<tr>
<td>Bitmap</td>
<td>BitmapEncoder</td>
</tr>
<tr>
<td>BitmapDrawable</td>
<td>BitmapDrawableEncoder</td>
</tr>
<tr>
<td>GifDrawable</td>
<td>GifDrawableEncoder</td>
</tr>
</tbody>
</table>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//用于将数据从资源写入某些持久性数据存储的接口，例如文件</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ResourceEncoder</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">Encoder</span>&lt;<span class="title">Resource</span>&lt;<span class="title">T</span>&gt;&gt; </span>&#123;</span><br><span class="line">    <span class="comment">//获取对应的策略模式</span></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="function">EncodeStrategy <span class="title">getEncodeStrategy</span><span class="params">(@NonNull Options options)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ResourceEncoder进行资源编码缓存枚举</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> EncodeStrategy &#123;</span><br><span class="line">    <span class="comment">//将资源的原始未修改数据写入磁盘,不包括采样和转化</span></span><br><span class="line">    SOURCE,</span><br><span class="line">    <span class="comment">//将资源的解码，下采样和转换后的数据写入磁盘。</span></span><br><span class="line">    TRANSFORMED,</span><br><span class="line">    <span class="comment">/** Will write no data. */</span></span><br><span class="line">    NONE,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>ResourceEncoderRegistry</code> ：包含能够编码任意资源类型的<code>ResourceEncoder</code>的有序列表。</p>
</blockquote>
<table>
<thead>
<tr>
<th>ResourceClass</th>
<th>ResourceEncoder</th>
</tr>
</thead>
<tbody>
<tr>
<td>BitmapDrawable</td>
<td>BitmapDrawableEncoder</td>
</tr>
<tr>
<td>GifDrawable</td>
<td>GifDrawableEncoder</td>
</tr>
<tr>
<td>Bitmap</td>
<td>BitmapEncoder</td>
</tr>
</tbody>
</table>
<h3 id="Decoder"><a href="#Decoder" class="headerlink" title="Decoder"></a>Decoder</h3><p><strong>Decoder</strong>：解码给定的资源类型文件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *用于解码资源的接口。</span></span><br><span class="line"><span class="comment"> *<span class="doctag">@param</span> &lt;T&gt;将从中解码资源的类型（文件，InputStream等）。</span></span><br><span class="line"><span class="comment"> *<span class="doctag">@param</span> &lt;Z&gt;解码资源的类型（位图，可绘制等）。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ResourceDecoder</span>&lt;<span class="title">T</span>, <span class="title">Z</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *如果此解码器能够使用给定的源解码给定的源，则返回true选项，否则为false。</span></span><br><span class="line"><span class="comment">     *解码器应尽最大努力快速确定是否可能够解码数据，但不应尝试完全读取给定的数据。</span></span><br><span class="line"><span class="comment">     *典型的实现将检查文件头，以确保它们与解码器期望的内容匹配句柄（即GIF解码器应验证图像是否包含GIF标头块)。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">handles</span><span class="params">(@NonNull T source, @NonNull Options options)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">    <span class="comment">//从给定的数据返回已解码的资源；如果无法解码任何资源，则返回null。</span></span><br><span class="line">    <span class="comment">//注意width和height参数仅是提示，没有要求解码后的资源与给定尺寸完全匹配。</span></span><br><span class="line">    <span class="comment">//一个典型的用例将使用目标尺寸来确定对位图进行降采样的量，以避免分配过多。</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function">Resource&lt;Z&gt; <span class="title">decode</span><span class="params">(@NonNull T source, <span class="keyword">int</span> width, <span class="keyword">int</span> height, @NonNull Options options)</span><span class="keyword">throws</span> IOException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>ResourceDecoderRegistry</code> ：包含<code>ResourceDecoder</code>的有序列表，这些列表可以将任意数据类型解码为从最高优先级解码器到最低优先级解码器的任意资源类型。</p>
</blockquote>
<table>
<thead>
<tr>
<th>Bucket</th>
<th>DataClass</th>
<th>ResourceClass</th>
<th>ResourceDecoder</th>
</tr>
</thead>
<tbody>
<tr>
<td>Bitmap</td>
<td>ByteBuffer</td>
<td>Bitmap</td>
<td>ByteBufferBitmapImageDecoderResourceDecoder</td>
</tr>
<tr>
<td>Bitmap</td>
<td>InputStream</td>
<td>Bitmap</td>
<td>InputStreamBitmapImageDecoderResourceDecoder</td>
</tr>
<tr>
<td>Bitmap</td>
<td>ParcelFileDescriptor</td>
<td>Bitmap</td>
<td>VideoDecoder</td>
</tr>
<tr>
<td>Bitmap</td>
<td>AssetFileDescriptor</td>
<td>Bitmap</td>
<td>VideoDecoder</td>
</tr>
<tr>
<td>Bitmap</td>
<td>Bitmap</td>
<td>Bitmap</td>
<td>UnitBitmapDecoder</td>
</tr>
<tr>
<td>Bitmap</td>
<td>GifDecoder</td>
<td>Bitmap</td>
<td>GifFrameResourceDecoder</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>Bucket</th>
<th>DataClass</th>
<th>ResourceClass</th>
<th>ResourceDecoder</th>
</tr>
</thead>
<tbody>
<tr>
<td>BitmapDrawables</td>
<td>ByteBuffer</td>
<td>BitemapDrawable</td>
<td>BitmapDrawableDecoder</td>
</tr>
<tr>
<td>BitmapDrawables</td>
<td>InputStream</td>
<td>BitemapDrawable</td>
<td>BitmapDrawableDecoder</td>
</tr>
<tr>
<td>BitmapDrawables</td>
<td>ParcelFileDescriptor</td>
<td>BitemapDrawable</td>
<td>BitmapDrawableDecoder</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>Bucket</th>
<th>DataClass</th>
<th>ResourceClass</th>
<th>ResourceDecoder</th>
</tr>
</thead>
<tbody>
<tr>
<td>Gif</td>
<td>ByteBuffer</td>
<td>GifDrawable</td>
<td>ByteBufferGifDecoder</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>Bucket</th>
<th>DataClass</th>
<th>ResourceClass</th>
<th>ResourceDecoder</th>
</tr>
</thead>
<tbody>
<tr>
<td>All</td>
<td>Uri</td>
<td>Drawable</td>
<td>ResourceDrawableDecoder</td>
</tr>
<tr>
<td>All</td>
<td>Uri</td>
<td>Bitmap</td>
<td>ResourceBitmapDecoder</td>
</tr>
<tr>
<td>All</td>
<td>File</td>
<td>File</td>
<td>FileDecoder</td>
</tr>
<tr>
<td>All</td>
<td>Drawable</td>
<td>Drawable</td>
<td>UnitDrawableDecoder</td>
</tr>
</tbody>
</table>
<h3 id="Transcoder"><a href="#Transcoder" class="headerlink" title="Transcoder"></a>Transcoder</h3><p><strong>Transcoder</strong>：将一种类型的资源转码为另一种类型的资源。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将一种类型的资源转码为另一种类型的资源。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;Z&gt; 要被转码的资源类型</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;R&gt; 需要转成的资源类型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ResourceTranscoder</span>&lt;<span class="title">Z</span>, <span class="title">R</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">//将给定资源转码为新资源类型并返回新资源。</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function">Resource&lt;R&gt; <span class="title">transcode</span><span class="params">(@NonNull Resource&lt;Z&gt; toTranscode, @NonNull Options options)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>TranscoderRegistry</code> ：该类允许<code>ResourceTranscoder</code>在它们之间进行转换的类中进行注册和检索。</p>
</blockquote>
<table>
<thead>
<tr>
<th>ResourceClass</th>
<th>TranscoeClass</th>
<th>ResourceTranscoder</th>
</tr>
</thead>
<tbody>
<tr>
<td>Bitmap</td>
<td>BitmapDrawable</td>
<td>BitmapDrawableTranscoder</td>
</tr>
<tr>
<td>Bitmap</td>
<td>byte[]</td>
<td>BitmapBytesTranscoder</td>
</tr>
<tr>
<td>Drawable</td>
<td>byte[]</td>
<td>DrawableBytesTranscoder</td>
</tr>
<tr>
<td>GifDrawable</td>
<td>byte[]</td>
<td>GifDrawableBytesTranscoder</td>
</tr>
</tbody>
</table>
<h3 id="ModelLoader"><a href="#ModelLoader" class="headerlink" title="ModelLoader"></a>ModelLoader</h3><p><code>ModelLoader</code> 是<code>Glide</code> 比较核心的类，主要是用来加载数据源<code>Model</code> 中的数据。</p>
<p>一般加载资源类型有<code>Bitmap</code> 、<code>String(网络图片、本地图片、资源图片)</code> 、<code>Uri(网络图片、本地图片、资源图片)</code> 、<code>URL(网络图片)</code> 、<code>Integer(资源图片)</code> 和<code>File(本地文件)</code>等。</p>
<p><code>Glide</code> 为每中资源类型设计了对应的<code>ModelLoaderFactory</code> ，每种<code>ModelLoaderFactory</code>对应一种<code>ModleLoader</code>。</p>
<p>资源类型可以相互转化，比如<code>String</code>转<code>URL</code>。所以<code>ModelLoader</code> 内部也是可以相互进行代理。</p>
<center><img src="https://img-blog.csdnimg.cn/20191220185627504.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9kYW5kYW5sb3ZlLmJsb2cuY3Nkbi5uZXQ=,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></center>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.bumptech.glide.load.model.MultiModelLoaderFactory</span></span><br><span class="line"><span class="comment">//通过仅在以下位置创建加载器来避免堆栈溢出递归地创建模型加载器</span></span><br><span class="line"><span class="comment">//递归请求（如果尚未在链中的早期创建）。例如：Uri加载程序可以转换为另一个模型，而后者又可以转换回Uri。</span></span><br><span class="line"><span class="comment">//尽管原始Uri加载程序不会提供给中间模型加载程序，其他的Uri装载程序也会。</span></span><br><span class="line"><span class="keyword">synchronized</span> &lt;Model&gt; List&lt;ModelLoader&lt;Model, ?&gt;&gt; build(<span class="meta">@NonNull</span> Class&lt;Model&gt; modelClass) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        List&lt;ModelLoader&lt;Model, ?&gt;&gt; loaders = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Entry&lt;?, ?&gt; entry : entries) &#123;</span><br><span class="line">            <span class="keyword">if</span> (alreadyUsedEntries.contains(entry)) &#123;<span class="comment">//去重</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (entry.handles(modelClass)) &#123;</span><br><span class="line">                alreadyUsedEntries.add(entry);</span><br><span class="line">                <span class="comment">//递归调用MultiModelLoaderFactory.build</span></span><br><span class="line">                loaders.add(<span class="keyword">this</span>.&lt;Model, Object&gt;build(entry));</span><br><span class="line">                alreadyUsedEntries.remove(entry);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> loaders;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        alreadyUsedEntries.clear();</span><br><span class="line">        <span class="keyword">throw</span> t;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//调用ModelLoaderFactory.build</span></span><br><span class="line"><span class="keyword">private</span> &lt;Model, Data&gt; <span class="function">ModelLoader&lt;Model, Data&gt; <span class="title">build</span><span class="params">(@NonNull Entry&lt;?, ?&gt; entry)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (ModelLoader&lt;Model, Data&gt;) Preconditions.checkNotNull(entry.factory.build(<span class="keyword">this</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>比如<code>ModelClass</code> 是 <code>String</code> 类型，我们遍历找到 <code>StreamFactory</code> ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">StreamFactory</span> <span class="keyword">implements</span> <span class="title">ModelLoaderFactory</span>&lt;<span class="title">String</span>, <span class="title">InputStream</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelLoader&lt;String, InputStream&gt; <span class="title">build</span><span class="params">(@NonNull MultiModelLoaderFactory multiFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> StringLoader&lt;&gt;(multiFactory.build(Uri.class, InputStream.class));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">teardown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="comment">// Do nothing.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个时候有会进行一次递归：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.bumptech.glide.load.model.MultiModelLoaderFactory</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> &lt;Model, Data&gt; <span class="function">ModelLoader&lt;Model, Data&gt; <span class="title">build</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      @NonNull Class&lt;Model&gt; modelClass, @NonNull Class&lt;Data&gt; dataClass)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        List&lt;ModelLoader&lt;Model, Data&gt;&gt; loaders = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">boolean</span> ignoredAnyEntries = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (Entry&lt;?, ?&gt; entry : entries) &#123;</span><br><span class="line">            <span class="keyword">if</span> (alreadyUsedEntries.contains(entry)) &#123;<span class="comment">//去重</span></span><br><span class="line">                ignoredAnyEntries = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (entry.handles(modelClass, dataClass)) &#123;</span><br><span class="line">                alreadyUsedEntries.add(entry);</span><br><span class="line">                <span class="comment">//递归调用MultiModelLoaderFactory.build</span></span><br><span class="line">                loaders.add(<span class="keyword">this</span>.&lt;Model, Data&gt;build(entry));</span><br><span class="line">                alreadyUsedEntries.remove(entry);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (loaders.size() &gt; <span class="number">1</span>) &#123;<span class="comment">//数量大于1的时候构建MultiModelLoader存储loaders</span></span><br><span class="line">            <span class="keyword">return</span> factory.build(loaders, throwableListPool);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (loaders.size() == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> loaders.get(<span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//如果递归导致没有可用的加载程序，请避免崩溃。该断言应该捕获完全未处理的类型，递归可能意味着未在某处处理子类型进入堆栈，这通常是可以的。 </span></span><br><span class="line">            <span class="keyword">if</span> (ignoredAnyEntries) &#123;</span><br><span class="line">                <span class="keyword">return</span> emptyModelLoader();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NoModelLoaderAvailableException(modelClass, dataClass);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        alreadyUsedEntries.clear();</span><br><span class="line">        <span class="keyword">throw</span> t;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以我们根据<code>Model</code>的类型从注册到<code>Glide</code>的<code>ModelLoaderFactory</code>中寻找匹配项，这个查找是按照添加的顺序进行遍历。找到对应的<code>ModelLoaderFactory</code> 在生成 <code>ModelLoader</code>的时候可能会继续寻找它的代理的<code>ModelLoader</code>，直到不需要代理为止，我们会对这个结果<strong>去重</strong>然后如果结果数量大于<strong>1</strong>那么会生成<code>MultiModelLoader</code> 存储这一组 <code>ModelLoader</code> 。如果这组中的 <code>ModelLoader</code> 中还包括 <code>MultiModelLoader</code> 那么这个 <code>MultiModelLoader</code> 内还会有一组 <code>ModelLoader</code> 。</p>
<p>下面为<strong>ModelLoader</strong>涉及到的类:</p>
<blockquote>
<p><code>DataSource</code> ：表示某些检索到的数据的来源。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> DataSource &#123;</span><br><span class="line">    <span class="comment">//表示数据可能是从设备本地检索的，尽管可能已经是通过可能已从远程源获取数据的内容提供者获得的。</span></span><br><span class="line">    LOCAL,</span><br><span class="line">    <span class="comment">//表示从设备以外的远程源检索到数据。</span></span><br><span class="line">    REMOTE,</span><br><span class="line">    <span class="comment">//表示从设备缓存中检索的数据未经修改。</span></span><br><span class="line">    DATA_DISK_CACHE,</span><br><span class="line">    <span class="comment">//表示数据是从设备上缓存中的已修改内容中检索到的。</span></span><br><span class="line">    RESOURCE_DISK_CACHE,</span><br><span class="line">    <span class="comment">//表示已从内存缓存中检索数据。</span></span><br><span class="line">    MEMORY_CACHE,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>DataFetcher</code> ：加载资源的数据。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 懒惰地检索可用于加载资源的数据。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;T&gt; 要加载的数据类型  (InputStream, byte[], File etc).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DataFetcher</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">//获取可以从中解码资源的数据。</span></span><br><span class="line">    <span class="comment">//没有数据的时候调用，异步线程执行，io不会阻塞</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">loadData</span><span class="params">(@NonNull Priority priority, @NonNull DataCallback&lt;? <span class="keyword">super</span> T&gt; callback)</span></span>;</span><br><span class="line">    <span class="comment">//清理或回收此数据获取器使用的任何资源。</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">cleanup</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//取消任务</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">cancel</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//返回此访存器将尝试获取的数据的类。</span></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="function">Class&lt;T&gt; <span class="title">getDataClass</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//返回要处理的资源数据类型</span></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="function">DataSource <span class="title">getDataSource</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>ModelLoaderFactory</code> ：用于为给定模型类型创建<code>ModelLoader</code>的接口。使用设计模式之工厂模式，让每一个<code>ModelLoader</code> 对应一个工厂。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ModelLoaderFactory</span>&lt;<span class="title">T</span>, <span class="title">Y</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">//为此模型类型构建一个具体的ModelLoader。</span></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="function">ModelLoader&lt;T, Y&gt; <span class="title">build</span><span class="params">(@NonNull MultiModelLoaderFactory multiFactory)</span></span>;</span><br><span class="line">    <span class="comment">//一种生命周期方法，该工厂即将被替换时将被调用。</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">teardown</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>ModelLoader</code> ：用于将任意复杂的数据模型转换为具体的数据类型。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *工厂接口，用于将任意复杂的数据模型转换为具体的数据类型,DataFetcher可以使用来获取由模型。</span></span><br><span class="line"><span class="comment"> *此接口有两个目标：</span></span><br><span class="line"><span class="comment"> *1.将特定模型转换为可以被解码为资源。</span></span><br><span class="line"><span class="comment"> *2.允许将模型与视图的尺寸组合以获取模型的资源具体尺寸。</span></span><br><span class="line"><span class="comment"> *这不仅避免了必须在xml和代码中重复尺寸，以便确定具有不同密度的设备上视图的大小，</span></span><br><span class="line"><span class="comment"> *但也允许您使用布局权重或通过编程方式放置视图的尺寸而不会强迫您获取通用资源大小。</span></span><br><span class="line"><span class="comment"> *您获取的资源越小，使用的带宽和电池寿命越少，并且越低每个资源的内存占用量。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *<span class="doctag">@param</span> &lt;Model&gt; 模型的类型。</span></span><br><span class="line"><span class="comment"> *<span class="doctag">@param</span> &lt;Data&gt; 可以使用的数据类型ResourceDecoder来解码资源。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ModelLoader</span>&lt;<span class="title">Model</span>, <span class="title">Data</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">//返回可以解码model的LoadData来进行资源解码</span></span><br><span class="line">    <span class="comment">//注意-如果无法返回有效的数据提取程序（例如，如果模型的URL为空），然后可以从此方法返回空数据获取程序。</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function">LoadData&lt;Data&gt; <span class="title">buildLoadData</span><span class="params">(@NonNull Model model, <span class="keyword">int</span> width, <span class="keyword">int</span> height, @NonNull Options options)</span></span>;</span><br><span class="line">    <span class="comment">//当前的数据模型是否能被处理</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">handles</span><span class="params">(@NonNull Model model)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>LoadData</code> ：加载的资源的<code>Key</code>和对应加载该资源的<code>DataFetcher</code> 的包装对象。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//包含一组标识负载源的keys，指向等效数据的备用缓存键以及DataFetcher，可用于获取在缓存中找不到的数据。</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoadData</span>&lt;<span class="title">Data</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">final</span> Key sourceKey;<span class="comment">//数据源标识</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">final</span> List&lt;Key&gt; alternateKeys;<span class="comment">//备用的标识</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">final</span> DataFetcher&lt;Data&gt; fetcher;<span class="comment">//可用于加载资源的数据</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">LoadData</span><span class="params">(@NonNull Key sourceKey, @NonNull DataFetcher&lt;Data&gt; fetcher)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(sourceKey, Collections.&lt;Key&gt;emptyList(), fetcher);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">LoadData</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    @NonNull Key sourceKey,</span></span></span><br><span class="line"><span class="function"><span class="params">    @NonNull List&lt;Key&gt; alternateKeys,</span></span></span><br><span class="line"><span class="function"><span class="params">    @NonNull DataFetcher&lt;Data&gt; fetcher)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.sourceKey = Preconditions.checkNotNull(sourceKey);</span><br><span class="line">    <span class="keyword">this</span>.alternateKeys = Preconditions.checkNotNull(alternateKeys);</span><br><span class="line">    <span class="keyword">this</span>.fetcher = Preconditions.checkNotNull(fetcher);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>ModelLoaderRegistry</code> ：维护<code>ModelLoader</code>的有序放置以及它们处理的模型和数据类型,从最高优先级到最低优先级的顺序。</p>
</blockquote>
<table>
<thead>
<tr>
<th>ModelClass</th>
<th>DataClass</th>
<th>ModelLoaderFactory</th>
</tr>
</thead>
<tbody>
<tr>
<td>Bitmap</td>
<td>Bitmap</td>
<td>UnitModelLoader.Factory</td>
</tr>
<tr>
<td>GifDecoder</td>
<td>GifDecoder</td>
<td>UnitModelLoader.Factory</td>
</tr>
<tr>
<td>File</td>
<td>ByteBuffer</td>
<td>ByteBufferFileLoader.Factory</td>
</tr>
<tr>
<td>File</td>
<td>InputStream</td>
<td>FileLoader.StreamFactory</td>
</tr>
<tr>
<td>File</td>
<td>ParcelFileDescriptor</td>
<td>FileLoader.FileDescriptorFactory</td>
</tr>
<tr>
<td>File</td>
<td>File</td>
<td>UnitModelLoader.Factory</td>
</tr>
<tr>
<td>int</td>
<td>InputStream</td>
<td>ResourceLoader.StreamFactory</td>
</tr>
<tr>
<td>int</td>
<td>ParcelFileDescriptor</td>
<td>ResourceLoader.FileDescriptorFactory</td>
</tr>
<tr>
<td>int</td>
<td>Uri</td>
<td>ResourceLoader.UriFactory</td>
</tr>
<tr>
<td>int</td>
<td>AssetFileDescriptor</td>
<td>ResourceLoader.AssetFileDescriptorFactory</td>
</tr>
<tr>
<td>Integer</td>
<td>InputStream</td>
<td>ResourceLoader.StreamFactory</td>
</tr>
<tr>
<td>Integer</td>
<td>ParcelFileDescriptor</td>
<td>ResourceLoader.FileDescriptorFactory</td>
</tr>
<tr>
<td>Integer</td>
<td>Uri</td>
<td>ResourceLoader.UriFactory</td>
</tr>
<tr>
<td>Integer</td>
<td>AssetFileDescriptor</td>
<td>ResourceLoader.AssetFileDescriptorFactory</td>
</tr>
<tr>
<td>String</td>
<td>InputStream</td>
<td>DataUrlLoader.StreamFactory</td>
</tr>
<tr>
<td>String</td>
<td>InputStream</td>
<td>StringLoader.StreamFactory</td>
</tr>
<tr>
<td>String</td>
<td>ParcelFileDescriptor</td>
<td>StringLoader.FileDescriptorFactory</td>
</tr>
<tr>
<td>String</td>
<td>AssetFileDescriptor</td>
<td>StringLoader.AssetFileDescriptorFactory</td>
</tr>
<tr>
<td>Uri</td>
<td>InputStream</td>
<td>DataUrlLoader.StreamFactory</td>
</tr>
<tr>
<td>Uri</td>
<td>InputStream</td>
<td>HttpUriLoader.Factory()</td>
</tr>
<tr>
<td>Uri</td>
<td>InputStream</td>
<td>AssetUriLoader.StreamFactory</td>
</tr>
<tr>
<td>Uri</td>
<td>InputStream</td>
<td>MediaStoreImageThumbLoader.Factory</td>
</tr>
<tr>
<td>Uri</td>
<td>InputStream</td>
<td>MediaStoreVideoThumbLoader.Factory</td>
</tr>
<tr>
<td>Uri</td>
<td>InputStream</td>
<td>UriLoader.StreamFactory</td>
</tr>
<tr>
<td>Uri</td>
<td>InputStream</td>
<td>UrlUriLoader.StreamFactory</td>
</tr>
<tr>
<td>Uri</td>
<td>ParcelFileDescriptor</td>
<td>AssetUriLoader.FileDescriptorFactory</td>
</tr>
<tr>
<td>Uri</td>
<td>ParcelFileDescriptor</td>
<td>UriLoader.FileDescriptorFactory</td>
</tr>
<tr>
<td>Uri</td>
<td>AssetFileDescriptor</td>
<td>UriLoader.AssetFileDescriptorFactory</td>
</tr>
<tr>
<td>Uri</td>
<td>File</td>
<td>MediaStoreFileLoader.Factory</td>
</tr>
<tr>
<td>Uri</td>
<td>Uri</td>
<td>UnitModelLoader.Factory</td>
</tr>
<tr>
<td>URL</td>
<td>InputStream</td>
<td>UrlLoader.StreamFactory</td>
</tr>
<tr>
<td>GlideUrl</td>
<td>InputStream</td>
<td>HttpGlideUrlLoader.Factory</td>
</tr>
<tr>
<td>byte[]</td>
<td>InputStream</td>
<td>ByteArrayLoader.StreamFactory</td>
</tr>
<tr>
<td>byte[]</td>
<td>ByteBuffer</td>
<td>ByteArrayLoader.ByteBufferFactory</td>
</tr>
<tr>
<td>Drawable</td>
<td>Drawable</td>
<td>UnitModelLoader.Factory</td>
</tr>
</tbody>
</table>
<p>我们现在就用 <code>String</code> 类型的网络图片地址的 <code>Model</code> 来看一下：</p>
<p>寻找处理 <code>String</code> 的 <code>ModelLoader</code> :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">DataUrlLoader.StreamFactory.build=DataUrlLoader</span><br><span class="line">  </span><br><span class="line">StringLoader.StreamFactory.build</span><br><span class="line">  =MultiModelLoaderFactory(Uri.class, InputStream.class)=MultiModelLoader</span><br><span class="line">  ==&gt;DataUrlLoader.StreamFactory=DataUrlLoader</span><br><span class="line">  ==&gt;HttpUriLoader.Factory=HttpUriLoader</span><br><span class="line">  ==&gt;==&gt;MultiModelLoaderFactory(Uri.class, ParcelFileDescriptor.class)</span><br><span class="line">  ==&gt;==&gt;==&gt;AssetUriLoader.FileDescriptorFactory=AssetUriLoader</span><br><span class="line">  ==&gt;==&gt;==&gt;UriLoader.FileDescriptorFactory=AssetUriLoader</span><br><span class="line">  ==&gt;==&gt;==&gt;AssetUriLoader(去重)</span><br><span class="line">  ==&gt;AssetUriLoader.StreamFactory=AssetUriLoader</span><br><span class="line">  ==&gt;MediaStoreImageThumbLoader.Factory=MediaStoreImageThumbLoader</span><br><span class="line">  ==&gt;MediaStoreVideoThumbLoader.Factory=MediaStoreVideoThumbLoader</span><br><span class="line">  ==&gt;UriLoader.StreamFactory=AssetUriLoader</span><br><span class="line">  ==&gt;UrlUriLoader.StreamFactory</span><br><span class="line">  ==&gt;==&gt;MultiModelLoaderFactory(GlideUrl.class, InputStream.class)</span><br><span class="line">  ==&gt;==&gt;==&gt;HttpGlideUrlLoader.Factory=HttpGlideUrlLoader</span><br><span class="line">  </span><br><span class="line">StringLoader.FileDescriptorFactory.build</span><br><span class="line">  =MultiModelLoaderFactory(Uri.class, ParcelFileDescriptor.class)=MultiModelLoader</span><br><span class="line">  ==&gt;AssetUriLoader.FileDescriptorFactory=AssetUriLoader</span><br><span class="line">  ==&gt;UriLoader.FileDescriptorFactory=UriLoader</span><br><span class="line">  </span><br><span class="line">StringLoader.AssetFileDescriptorFactory.build</span><br><span class="line">  =MultiModelLoaderFactory(Uri.class, AssetFileDescriptor.class)</span><br><span class="line">  =UriLoader.AssetFileDescriptorFactory=UriLoader</span><br></pre></td></tr></table></figure>
<center><img src="https://img-blog.csdnimg.cn/20191220185656297.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9kYW5kYW5sb3ZlLmJsb2cuY3Nkbi5uZXQ=,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></center>

<p>接下来对这一组 <code>ModelLoader</code> 进行处理，过滤掉无法处理 <code>Model</code> 数据的 <code>ModelLoader</code> 。其中 <code>MultiModelLoader</code> 中只要有一个 <code>ModelLoader</code> 能处理 <code>Model</code> 数据， 那么这个 <code>MultiModelLoader</code> 就可以不被过滤。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">StringLoader.StreamFactory=MultiModelLoader[<span class="number">7</span>]</span><br><span class="line">StringLoader.FileDescriptorFactory=MultiModelLoader[<span class="number">2</span>]</span><br><span class="line">StringLoader.AssetFileDescriptorFactory=UriLoader</span><br></pre></td></tr></table></figure>
<center><img src="https://img-blog.csdnimg.cn/20191220185718404.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9kYW5kYW5sb3ZlLmJsb2cuY3Nkbi5uZXQ=,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></center>

<h3 id="Transformation"><a href="#Transformation" class="headerlink" title="Transformation"></a>Transformation</h3><p><a href="https://muyangmin.github.io/glide-docs-cn/doc/transformations.html" target="_blank" rel="noopener">Glid-Transformation文档：https://muyangmin.github.io/glide-docs-cn/doc/transformations.html</a></p>
<p><strong>Transformation</strong>：用于在实现资源上执行任意转换的类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//唯一标识某些数据放置的接口。</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Key</span> </span>&#123;</span><br><span class="line">    String STRING_CHARSET_NAME = <span class="string">"UTF-8"</span>;</span><br><span class="line">    Charset CHARSET = Charset.forName(STRING_CHARSET_NAME);</span><br><span class="line">    <span class="comment">//将所有唯一标识信息添加到给定的摘要中。</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateDiskCacheKey</span><span class="params">(@NonNull MessageDigest messageDigest)</span></span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span></span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//用于在实现资源上执行任意转换的类</span></span><br><span class="line"><span class="comment">//equals和hashCode来标识内存缓存中的转换</span></span><br><span class="line"><span class="comment">//updateDiskCacheKey来标识磁盘中的转换缓存。</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Transformation</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">Key</span> </span>&#123;</span><br><span class="line">    <span class="comment">//转换给定资源并返回转换后的资源</span></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="function">Resource&lt;T&gt; <span class="title">transform</span><span class="params">(@NonNull Context context, @NonNull Resource&lt;T&gt; resource, <span class="keyword">int</span> outWidth, <span class="keyword">int</span> outHeight)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="DataRewinder"><a href="#DataRewinder" class="headerlink" title="DataRewinder"></a>DataRewinder</h3><p><strong>DataRewinder</strong>：对数据的游标进行重置，也就是所谓的倒带。</p>
<p>这个逻辑在上一篇文章 <a href="https://dandanlove.blog.csdn.net/article/details/103256724" target="_blank" rel="noopener">Android-Universal-Image-Loader源码分析</a> 中也有讲到过，我们拿到数据流之后可能会从它的头部信息中获取一些图片本身的参数，然后我们再将数据流写入文件缓存的时候要重置数据流的游标保证写入的数据完整。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DataRewinder</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">Factory</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">      <span class="meta">@NonNull</span></span><br><span class="line">      <span class="function">DataRewinder&lt;T&gt; <span class="title">build</span><span class="params">(@NonNull T data)</span></span>;</span><br><span class="line">      <span class="meta">@NonNull</span></span><br><span class="line">      <span class="function">Class&lt;T&gt; <span class="title">getDataClass</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//将包装的数据回退到实例化此对象时的位置，然后返回重新包装的数据</span></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="function">T <span class="title">rewindAndGet</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">    <span class="comment">//当不再需要该复卷机并可以对其进行清理时调用。</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">cleanup</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Glide</code> 中的 <code>DataRewinder</code> 模块设计也使用的是<strong>工厂模式</strong>。</p>
<table>
<thead>
<tr>
<th>DataClass</th>
<th>DataRewinder</th>
<th>Factory</th>
<th>添加时机</th>
</tr>
</thead>
<tbody>
<tr>
<td>InputStream</td>
<td>InputStreamRewinder</td>
<td>InputStreamRewinder.Factory</td>
<td>Glide构造中注册</td>
</tr>
<tr>
<td>ByteBuffer</td>
<td>ByteBufferRewinder</td>
<td>ByteBufferRewinder.Factory</td>
<td>Glide构造中注册</td>
</tr>
<tr>
<td>ALL</td>
<td>DefaultRewinder</td>
<td>DEFAULT_FACTORY</td>
<td>默认值，不用添加</td>
</tr>
</tbody>
</table>
<h3 id="Transition"><a href="#Transition" class="headerlink" title="Transition"></a>Transition</h3><p><code>Transition</code> 不是由<code>Glide</code>进行注册的，而是我们在业务代码中按照需要添加的。它作为<code>Glide</code>组件的一种，所以我们放在这里来进行介绍。</p>
<p><a href="https://muyangmin.github.io/glide-docs-cn/doc/transitions.html" target="_blank" rel="noopener">Glide-Transition文档：https://muyangmin.github.io/glide-docs-cn/doc/transitions.html</a></p>
<p><code>Glide</code> 提供了很多的过渡效果，用户可以手动地应用于每个请求。<code>Glide</code> 的内置过渡以一致的方式运行，并且将根据加载图像的位置在某些情况下避免运行。</p>
<center><img src="https://img-blog.csdnimg.cn/201912201901022.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9kYW5kYW5sb3ZlLmJsb2cuY3Nkbi5uZXQ=,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></center>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//包装视图的目标将能够提供所有必要的参数并开始过渡。</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Transition</span>&lt;<span class="title">R</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">//包含视图的接口，该视图公开了运行各种类型的必需的方法</span></span><br><span class="line">    <span class="comment">//Glide中所有ViewTarget的子类都实现了该接口</span></span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">ViewAdapter</span> </span>&#123;</span><br><span class="line">        <span class="comment">//返回包装的view</span></span><br><span class="line">        <span class="function">View <span class="title">getView</span><span class="params">()</span></span>;</span><br><span class="line">        <span class="comment">//返回在视图中显示的当前可绘制对象；如果不存在这样的可绘制对象，则返回null（或无法检索）。</span></span><br><span class="line">        <span class="meta">@Nullable</span></span><br><span class="line">        <span class="function">Drawable <span class="title">getCurrentDrawable</span><span class="params">()</span></span>;</span><br><span class="line">        <span class="comment">//设置当前可绘制对象（通常是动画可绘制对象）以在包装视图中显示。</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">setDrawable</span><span class="params">(Drawable drawable)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//从当前正在使用的上一个Drawable进行动画处理在给定视图中显示，</span></span><br><span class="line">    <span class="comment">//如果在运行过渡过程中将新资源放在视图中，则为True，</span></span><br><span class="line">    <span class="comment">//如果调用者需要手动将当前资源放在视图上，则为false。</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">transition</span><span class="params">(R current, ViewAdapter adapter)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//一个工厂类，可以根据请求的状态产生不同的Transition</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TransitionFactory</span>&lt;<span class="title">R</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">//返回一个新的Transition</span></span><br><span class="line">    <span class="comment">//isFirstResource如果这是要加载到目标中的第一个资源，则为True。</span></span><br><span class="line">    <span class="function">Transition&lt;R&gt; <span class="title">build</span><span class="params">(DataSource dataSource, <span class="keyword">boolean</span> isFirstResource)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Glide使用"><a href="#Glide使用" class="headerlink" title="Glide使用"></a>Glide使用</h2><p>我们上面从业务代码中自定义的<code>@GlideModule</code>注解讲到了<code>Glide</code>的构造，以及<code>Glide</code>中模块&amp;组件的注册以及其对应的功能和处理逻辑。</p>
<p>接下来我们继续根据业务代码中<code>Glide</code>最常用的代码，来讲述<code>Glide</code>的其它部分。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Glide.with(context)</span><br><span class="line">    .load(myUrl)</span><br><span class="line">    .into(imageView);</span><br></pre></td></tr></table></figure>
<p>这段代码中有我们三个业务逻辑参数：<code>context</code>、<code>myUrl</code>、<code>imageView</code>。</p>
<blockquote>
<ul>
<li><code>context</code> ：本次加载图片的上下文环境；</li>
<li><code>myUrl</code> ：本次需要加载图片的地址，也叫数据；</li>
<li><code>imageView</code> ：本次需要加载图片的<code>View</code> ，也叫目标；</li>
</ul>
</blockquote>
<h2 id="RequestManager"><a href="#RequestManager" class="headerlink" title="RequestManager"></a>RequestManager</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Glide.with(context)</span><br></pre></td></tr></table></figure>
<p>根据这一行代码我们进行分析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.bumptech.glide.Glide.java</span></span><br><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RequestManager <span class="title">with</span><span class="params">(@NonNull Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getRetriever(context).get(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Glide.with(context)</code>获取的是<code>RequestManager</code> 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//用于管理和启动对Glide的请求的类。可以使用活动，片段和连接性生命周期事件智能地停止，启动和重新启动请求。</span></span><br><span class="line"><span class="comment">//通过实例化一个新对象或利用Activity和Fragment生命周期内置的处理功能进行检索，请对Fragment或Activity使用静态Glide.load方法。</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestManager</span></span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">ComponentCallbacks2</span>, <span class="title">LifecycleListener</span>, <span class="title">ModelTypes</span>&lt;<span class="title">RequestBuilder</span>&lt;<span class="title">Drawable</span>&gt;&gt; </span>&#123;</span><br><span class="line">    <span class="comment">/***代码全都省略***/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>ComponentCallbacks2</code> ：<code>Android</code> 自带的内存管理的接口，<code>Application</code> 和 <code>Activity</code> 都有实现。主要可以根据系统的内存状况及时调整App内存占用，提升用户体验或让App存活更久。</p>
</blockquote>
<blockquote>
<p><code>LifecycleListener</code> ：activity或者fragment的声明周期监听接口</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LifecycleListener</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span></span>;<span class="comment">//fragmetn或者activity的onstart</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onStop</span><span class="params">()</span></span>;<span class="comment">//fragmetn或者activity的onstop</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span></span>;<span class="comment">//fragmetn或者activity的ondestroy</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>ModelTypes</code> ：通俗的说就是<code>Glide</code>的<strong>API</strong>。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ModelTypes</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@CheckResult</span></span><br><span class="line">    <span class="function">T <span class="title">load</span><span class="params">(@Nullable Bitmap bitmap)</span></span>;</span><br><span class="line">    <span class="function">T <span class="title">load</span><span class="params">(@Nullable Drawable drawable)</span></span>;</span><br><span class="line">    <span class="function">T <span class="title">load</span><span class="params">(@Nullable String string)</span></span>;</span><br><span class="line">    <span class="function">T <span class="title">load</span><span class="params">(@Nullable Uri uri)</span></span>;</span><br><span class="line">    <span class="function">T <span class="title">load</span><span class="params">(@Nullable File file)</span></span>;</span><br><span class="line">    <span class="function">T <span class="title">load</span><span class="params">(@RawRes @DrawableRes @Nullable Integer resourceId)</span></span>;</span><br><span class="line">    <span class="function">T <span class="title">load</span><span class="params">(@Nullable URL url)</span></span>;</span><br><span class="line">    <span class="function">T <span class="title">load</span><span class="params">(@Nullable <span class="keyword">byte</span>[] model)</span></span>;</span><br><span class="line">    <span class="function">T <span class="title">load</span><span class="params">(@Nullable Object model)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="RequestManager的获取"><a href="#RequestManager的获取" class="headerlink" title="RequestManager的获取"></a>RequestManager的获取</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.bumptech.glide.manager.RequestManagerRetriever.java</span></span><br><span class="line"><span class="comment">//Application的生命周期单独管理</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> RequestManager applicationManager;</span><br><span class="line"><span class="comment">//一个是support包，一个是Android的api，RequestManagerFragment的临时存储</span></span><br><span class="line"><span class="comment">//RequestManagerFragment用来管理RequestManager和同步生命周期</span></span><br><span class="line"><span class="keyword">final</span> Map&lt;android.app.FragmentManager, RequestManagerFragment&gt; pendingRequestManagerFragments = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"><span class="keyword">final</span> Map&lt;FragmentManager, SupportRequestManagerFragment&gt; pendingSupportRequestManagerFragments = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"><span class="function"><span class="keyword">public</span> RequestManager <span class="title">get</span><span class="params">(@NonNull Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (context == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"You cannot start a load on a null Context"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Util.isOnMainThread() &amp;&amp; !(context <span class="keyword">instanceof</span> Application)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (context <span class="keyword">instanceof</span> FragmentActivity) &#123;<span class="comment">//FragmentActivity</span></span><br><span class="line">            <span class="keyword">return</span> get((FragmentActivity) context);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (context <span class="keyword">instanceof</span> Activity) &#123;<span class="comment">//Activity</span></span><br><span class="line">            <span class="keyword">return</span> get((Activity) context);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (context <span class="keyword">instanceof</span> ContextWrapper<span class="comment">//找到context的basecontext</span></span><br><span class="line">            &amp;&amp; ((ContextWrapper) context).getBaseContext().getApplicationContext() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> get(((ContextWrapper) context).getBaseContext());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> getApplicationManager(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们用<code>Fragment</code> 来举例看看<code>RequestManager</code>的获取（<code>Activity</code>和<code>FragmentActivity</code>的实现都类似）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> RequestManager <span class="title">get</span><span class="params">(@NonNull Fragment fragment)</span> </span>&#123;</span><br><span class="line">    Preconditions.checkNotNull(fragment.getContext(),<span class="string">"fragment必须被attch，不能被destroy"</span>);</span><br><span class="line">    <span class="keyword">if</span> (Util.isOnBackgroundThread()) &#123;<span class="comment">//如果应用在后台，那么切换为Application</span></span><br><span class="line">        <span class="keyword">return</span> get(fragment.getContext().getApplicationContext());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        FragmentManager fm = fragment.getChildFragmentManager();</span><br><span class="line">        <span class="keyword">return</span> supportFragmentGet(fragment.getContext(), fm, fragment, fragment.isVisible());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> RequestManager <span class="title">supportFragmentGet</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      @NonNull Context context,</span></span></span><br><span class="line"><span class="function"><span class="params">      @NonNull FragmentManager fm,</span></span></span><br><span class="line"><span class="function"><span class="params">      @Nullable Fragment parentHint,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">boolean</span> isParentVisible)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//获取当前上下文中的SupportRequestManagerFragment</span></span><br><span class="line">    SupportRequestManagerFragment current =</span><br><span class="line">        getSupportRequestManagerFragment(fm, parentHint, isParentVisible);</span><br><span class="line">    <span class="comment">//获取SupportRequestManagerFragment的RequestManager</span></span><br><span class="line">    RequestManager requestManager = current.getRequestManager();</span><br><span class="line">    <span class="keyword">if</span> (requestManager == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//给新创建的SupportRequestManagerFragment添加RequestManager</span></span><br><span class="line">        Glide glide = Glide.get(context);</span><br><span class="line">        requestManager =</span><br><span class="line">            factory.build(</span><br><span class="line">                glide, current.getGlideLifecycle(), current.getRequestManagerTreeNode(), context);</span><br><span class="line">        current.setRequestManager(requestManager);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> requestManager;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> SupportRequestManagerFragment <span class="title">getSupportRequestManagerFragment</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      @NonNull <span class="keyword">final</span> FragmentManager fm, @Nullable Fragment parentHint, <span class="keyword">boolean</span> isParentVisible)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//先看看当前的FragmentManager中有没有SupportRequestManagerFragment，有就复用</span></span><br><span class="line">    SupportRequestManagerFragment current = (SupportRequestManagerFragment) fm.findFragmentByTag(FRAGMENT_TAG);</span><br><span class="line">    <span class="keyword">if</span> (current == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//pendingSupportRequestManagerFragments，只是一个临时性的存储,因为每次put之后必定会remove</span></span><br><span class="line">        <span class="comment">//因为add之后立即进行findFragmentByTag是获取不到的，所以需要临时存储</span></span><br><span class="line">        current = pendingSupportRequestManagerFragments.get(fm);</span><br><span class="line">        <span class="keyword">if</span> (current == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//创建新的SupportRequestManagerFragment</span></span><br><span class="line">            current = <span class="keyword">new</span> SupportRequestManagerFragment();</span><br><span class="line">            current.setParentFragmentHint(parentHint);  </span><br><span class="line">            <span class="comment">//如果fragment已经展示，那么添加的SupportRequestManagerFragment也要同步生命周期</span></span><br><span class="line">            <span class="keyword">if</span> (isParentVisible) &#123;</span><br><span class="line">                current.getGlideLifecycle().onStart();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//添加临时存储</span></span><br><span class="line">            pendingSupportRequestManagerFragments.put(fm, current);</span><br><span class="line">            <span class="comment">//创建的SupportRequestManagerFragment添加到FragmentManager中</span></span><br><span class="line">            fm.beginTransaction().add(current, FRAGMENT_TAG).commitAllowingStateLoss();</span><br><span class="line">            <span class="comment">//删除临时存储</span></span><br><span class="line">            handler.obtainMessage(ID_REMOVE_SUPPORT_FRAGMENT_MANAGER, fm).sendToTarget();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> current;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="其它功能"><a href="#其它功能" class="headerlink" title="其它功能"></a>其它功能</h3><p>执行\取消一个请求、暂停所有请求、重启所有请求等对请求的标记，这部分会在<code>Request</code> 详细讲解。在说<code>Request</code> 之前先说一下<code>Request</code>需要为谁加载目标资源。</p>
<h2 id="Target"><a href="#Target" class="headerlink" title="Target"></a>Target</h2><blockquote>
<p><code>Target</code> ：在声明周期内Glide加载资源回调接口；</p>
<p><code>BaseTarget</code> ：用于加载<code>Resource</code>的基础 <code>Target</code> 大多数方法的基本或空实现；</p>
<p><code>TargetView</code> ：为Bitmap添加到View上提供了默认实现，</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Target</span>&lt;<span class="title">R</span>&gt; <span class="keyword">extends</span> <span class="title">LifecycleListener</span> </span>&#123;</span><br><span class="line">    <span class="comment">//表示我们希望资源保持其原始的未修改宽度和/或高度</span></span><br><span class="line">    <span class="keyword">int</span> SIZE_ORIGINAL = Integer.MIN_VALUE;</span><br><span class="line">    <span class="comment">//开始加载</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onLoadStarted</span><span class="params">(@Nullable Drawable placeholder)</span></span>;</span><br><span class="line">    <span class="comment">//加载失败</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onLoadFailed</span><span class="params">(@Nullable Drawable errorDrawable)</span></span>;</span><br><span class="line">    <span class="comment">//资源加载完成时将调用的方法。</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onResourceReady</span><span class="params">(@NonNull R resource, @Nullable Transition&lt;? <span class="keyword">super</span> R&gt; transition)</span></span>;</span><br><span class="line">    <span class="comment">//在取消负载及其资源释放时调用</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onLoadCleared</span><span class="params">(@Nullable Drawable placeholder)</span></span>;</span><br><span class="line">    <span class="comment">//一种检索此目标大小的方法</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">getSize</span><span class="params">(@NonNull SizeReadyCallback cb)</span></span>;</span><br><span class="line">    <span class="comment">//如果给定的回调仍保留，则将其从待处理集中删除</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">removeCallback</span><span class="params">(@NonNull SizeReadyCallback cb)</span></span>;</span><br><span class="line">    <span class="comment">//设置为此目标保留的当前请求</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setRequest</span><span class="params">(@Nullable Request request)</span></span>;</span><br><span class="line">    <span class="comment">//检索对此目标的当前请求</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function">Request <span class="title">getRequest</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="RequestBuilder"><a href="#RequestBuilder" class="headerlink" title="RequestBuilder"></a>RequestBuilder</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Glide.with(context)</span><br><span class="line">    .load(myUrl)</span><br></pre></td></tr></table></figure>
<p>我们继续看下一行<code>load</code>代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.bumptech.glide.RequestManager.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RequestBuilder&lt;Drawable&gt; <span class="title">load</span><span class="params">(@Nullable String string)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> asDrawable().load(string);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>RequestBuilder</code>通用类，可以处理通用资源类型的设置选项和启动负载。<code>GlideRequest</code>虽然继承了<code>RequestBuilder</code> 但内部的实现都是<code>super</code>调用父类的方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.bumptech.glide.RequestManager.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RequestBuilder&lt;Drawable&gt; <span class="title">asDrawable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> as(Drawable.class);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> &lt;ResourceType&gt; <span class="function">RequestBuilder&lt;ResourceType&gt; <span class="title">as</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      @NonNull Class&lt;ResourceType&gt; resourceClass)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RequestBuilder&lt;&gt;(glide, <span class="keyword">this</span>, resourceClass, context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>asDrawable</code> 创建一个请求资源类型为 <code>Drawable.class</code> 的 <code>RequestBuilder</code> 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.bumptech.glide.RequestBuilder.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="title">load</span><span class="params">(@Nullable String string)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> loadGeneric(string);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> RequestBuilder&lt;TranscodeType&gt; <span class="title">loadGeneric</span><span class="params">(@Nullable Object model)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.model = model;</span><br><span class="line">    isModelSet = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来设置这个 <code>RequestBuilder</code> 的 <code>Model</code> 为<code>String.class</code> 的 <code>myUrl</code> 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Glide.with(context)</span><br><span class="line">    .load(myUrl)</span><br><span class="line">    .into(imageView);</span><br></pre></td></tr></table></figure>
<p><code>RequestBuilder</code> 的 <code>into</code>  方法是 <code>Glide</code> 加载图片的最后一步。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ViewTarget&lt;ImageView, TranscodeType&gt; <span class="title">into</span><span class="params">(@NonNull ImageView view)</span> </span>&#123;</span><br><span class="line">    Util.assertMainThread();</span><br><span class="line">    Preconditions.checkNotNull(view);</span><br><span class="line">    BaseRequestOptions&lt;?&gt; requestOptions = <span class="keyword">this</span>;</span><br><span class="line">    <span class="comment">//下面是根据view修改requestOptions的属性</span></span><br><span class="line">    <span class="keyword">if</span> (!requestOptions.isTransformationSet()</span><br><span class="line">        &amp;&amp; requestOptions.isTransformationAllowed()</span><br><span class="line">        &amp;&amp; view.getScaleType() != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">switch</span> (view.getScaleType()) &#123;</span><br><span class="line">        <span class="keyword">case</span> CENTER_CROP:</span><br><span class="line">          requestOptions = requestOptions.clone().optionalCenterCrop();</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> CENTER_INSIDE:</span><br><span class="line">          requestOptions = requestOptions.clone().optionalCenterInside();</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> FIT_CENTER:</span><br><span class="line">        <span class="keyword">case</span> FIT_START:</span><br><span class="line">        <span class="keyword">case</span> FIT_END:</span><br><span class="line">          requestOptions = requestOptions.clone().optionalFitCenter();</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> FIT_XY:</span><br><span class="line">          requestOptions = requestOptions.clone().optionalCenterInside();</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> CENTER:</span><br><span class="line">        <span class="keyword">case</span> MATRIX:</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">          <span class="comment">// Do nothing.</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> into(</span><br><span class="line">        glideContext.buildImageViewTarget(view, transcodeClass),</span><br><span class="line">        <span class="comment">/*targetListener=*/</span> <span class="keyword">null</span>,</span><br><span class="line">        requestOptions,</span><br><span class="line">        Executors.mainThreadExecutor());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>into</code> 方法主要根据 <code>View</code> 的属性重构造 <code>requestOptions</code> ， 并生成 <code>DrawableImageViewTarget</code> 。</p>
<h3 id="ViewTarget的生成"><a href="#ViewTarget的生成" class="headerlink" title="ViewTarget的生成"></a>ViewTarget的生成</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GlideContext</span> <span class="keyword">extends</span> <span class="title">ContextWrapper</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> &lt;X&gt; <span class="function">ViewTarget&lt;ImageView, X&gt; <span class="title">buildImageViewTarget</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        @NonNull ImageView imageView, @NonNull Class&lt;X&gt; transcodeClass)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> imageViewTargetFactory.buildTarget(imageView, transcodeClass);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/***部分代码省略***/</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageViewTargetFactory</span> </span>&#123;</span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="keyword">public</span> &lt;Z&gt; <span class="function">ViewTarget&lt;ImageView, Z&gt; <span class="title">buildTarget</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        @NonNull ImageView view, @NonNull Class&lt;Z&gt; clazz)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Bitmap.class.equals(clazz)) &#123;</span><br><span class="line">            <span class="keyword">return</span> (ViewTarget&lt;ImageView, Z&gt;) <span class="keyword">new</span> BitmapImageViewTarget(view);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Drawable.class.isAssignableFrom(clazz)) &#123;</span><br><span class="line">            <span class="keyword">return</span> (ViewTarget&lt;ImageView, Z&gt;) <span class="keyword">new</span> DrawableImageViewTarget(view);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">            <span class="string">"Unhandled class: "</span> + clazz + <span class="string">", try .as*(Class).transcode(ResourceTranscoder)"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>transcodeClass</code> 实际就是上面的 <code>resourceClass</code> 也就是 <code>Drawable.class</code> 。</p>
<p>接下来我们继续看它的 <code>into</code> 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;Y extends Target&lt;TranscodeType&gt;&gt; <span class="function">Y <span class="title">into</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      @NonNull Y target,</span></span></span><br><span class="line"><span class="function"><span class="params">      @Nullable RequestListener&lt;TranscodeType&gt; targetListener,</span></span></span><br><span class="line"><span class="function"><span class="params">      BaseRequestOptions&lt;?&gt; options,</span></span></span><br><span class="line"><span class="function"><span class="params">      Executor callbackExecutor)</span> </span>&#123;</span><br><span class="line">    Preconditions.checkNotNull(target);</span><br><span class="line">    <span class="comment">//检测是否设置了model</span></span><br><span class="line">    <span class="keyword">if</span> (!isModelSet) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"You must call #load() before calling #into()"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//创建请求,Executors.mainThreadExecutor()标识callback在主线程</span></span><br><span class="line">    Request request = buildRequest(target, targetListener, options, callbackExecutor);</span><br><span class="line">    Request previous = target.getRequest();</span><br><span class="line">    <span class="comment">//如果target上的当前请求与上一次的相同，且请求缓存磁盘并且上一个请求为完成时使用上一个请求</span></span><br><span class="line">    <span class="keyword">if</span> (request.isEquivalentTo(previous)</span><br><span class="line">        &amp;&amp; !isSkipMemoryCacheWithCompletePreviousRequest(options, previous)) &#123;</span><br><span class="line">      <span class="comment">//如果请求已完成，请重新开始，以确保重新发送结果，触发RequestListeners和Targets。</span></span><br><span class="line">      <span class="comment">//如果请求失败，将重新开始重新启动请求，使它有另一个完成的机会。</span></span><br><span class="line">      <span class="comment">//如果请求已经正在运行，我们可以让它继续运行而不会受到干扰。</span></span><br><span class="line">      <span class="keyword">if</span> (!Preconditions.checkNotNull(previous).isRunning()) &#123;</span><br><span class="line">        <span class="comment">//使用上一个请求而不是新请求来进行优化，例如跳过设置占位符，跟踪和取消跟踪目标并获取视图尺寸在单独的请求中完成。 </span></span><br><span class="line">        previous.begin();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> target;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//清除target之前的请求</span></span><br><span class="line">    requestManager.clear(target);</span><br><span class="line">    <span class="comment">//给target设置新的请求</span></span><br><span class="line">    target.setRequest(request);</span><br><span class="line">    <span class="comment">//target同步requestmanager的声明周期，并将request添加到请求列表</span></span><br><span class="line">    requestManager.track(target, request);</span><br><span class="line">    <span class="keyword">return</span> target;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isSkipMemoryCacheWithCompletePreviousRequest</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    BaseRequestOptions&lt;?&gt; options, Request previous)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> !options.isMemoryCacheable() &amp;&amp; previous.isComplete();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>好吧，终于看见加载图片的请求了~！</p>
<p>这里会根据之前构建的一些参数来生成 <code>Request</code> ，然后和 <code>ViewTarget</code> 的 <code>Request</code> 进行比较决定是否重用之前的 <code>Request</code> ，或者清除之前的 <code>Request</code> 。</p>
<h2 id="Request"><a href="#Request" class="headerlink" title="Request"></a>Request</h2><blockquote>
<p><code>Request</code> ：为 <code>Target</code> 加载资源的请求。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Request</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">begin</span><span class="params">()</span></span>;<span class="comment">//开始异步加载</span></span><br><span class="line">    <span class="comment">//防止从以前的请求中加载任何位图，释放由此持有的任何资源请求，并将该请求标记为具有已取消。</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//暂停请求</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">pause</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//如果此请求正在运行并且尚未完成或失败，则返回true。</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isRunning</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//如果请求成功完成，则返回true</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isComplete</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//如果请求已清除，则返回true</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isCleared</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//判断两个请求是否相同</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isEquivalentTo</span><span class="params">(Request other)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Request的创建"><a href="#Request的创建" class="headerlink" title="Request的创建"></a>Request的创建</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Request request = buildRequest(target, targetListener, options, callbackExecutor);</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li><code>target</code> : 我们对 <code>ImageView</code> 包装之后的的 <code>ViewTarget</code>；</li>
<li><code>targetListener</code> ：默认为<code>null</code>；</li>
<li><code>options</code> ：为重新根据<code>view</code> 属性修改之后的 <code>requestOptions</code> ；</li>
<li><code>callbackExecutor</code> : 回调的线程池，在主线程中执行回调；</li>
</ul>
</blockquote>
<p>生成的<code>Request</code> 实例为 <code>SingleRequest</code>，它是专门为了<code>Target</code>而加载资源的。</p>
<p>如果需要设置处理 <code>Error</code> 的请求那么会在 <code>Request</code> 外包一层生成 <code>ErrorRequestCoordinator</code>。</p>
<blockquote>
<p><code>ErrorRequestCoordinator</code> ：运行单个主要的Request直到完成，然后仅在单个主要请求失败的情况下后退错误请求；</p>
</blockquote>
<p>如果需要设置处理缩略图的请求那么会在 <code>Request</code> 外包一层生成 <code>ThumbnailRequestCoordinator</code>。</p>
<blockquote>
<p><code>ThumbnailRequestCoordinator</code> ：一个协调器，用于协调两个单独的<code>Request</code>，它们同时加载图像的小缩略图版本和图像的完整尺寸版本。</p>
</blockquote>
<p>整个<code>Glide</code> 中 <code>Request</code> 的实现类就<code>SingleRequest</code> 、<code>ErrorRequestCoordinator</code> 和 <code>ThumbnailRequestCoordinator</code> 一共三个。</p>
<h3 id="SingleRequest"><a href="#SingleRequest" class="headerlink" title="SingleRequest"></a>SingleRequest</h3><p><code>SingleRequest</code> 不仅实现了 <code>Request</code> ，还实现了<code>SizeReadyCallback</code> 和 <code>ResourceCallback</code> 接口。</p>
<blockquote>
<p><code>SizeReadyCallback</code> ：当目标确定其大小时必须调用的回调。对于固定尺寸的目标可以同步调用。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SizeReadyCallback</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onSizeReady</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>ResourceCallback</code> ：侦听资源加载成功完成或失败的回调。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ResourceCallback</span> </span>&#123;</span><br><span class="line">  <span class="comment">//成功加载资源时调用。</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">onResourceReady</span><span class="params">(Resource&lt;?&gt; resource, DataSource dataSource)</span></span>;</span><br><span class="line">  <span class="comment">//当资源无法成功加载时调用。</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">onLoadFailed</span><span class="params">(GlideException e)</span></span>;</span><br><span class="line">  <span class="comment">//返回通知单个请求时要使用的锁</span></span><br><span class="line">  <span class="function">Object <span class="title">getLock</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面我们阅读<code>into</code>代码的时候知道了 <code>request</code> 的执行是调用了<code>RequestManager.track</code> 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.bumptech.glide.RequestManager</span></span><br><span class="line"><span class="comment">//对request进行追踪，默认的new RequestTracker()；</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> RequestTracker requestTracker；</span><br><span class="line"><span class="comment">//对target进行追踪</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> TargetTracker targetTracker = <span class="keyword">new</span> TargetTracker();</span><br><span class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">track</span><span class="params">(@NonNull Target&lt;?&gt; target, @NonNull Request request)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//添加到RequestManger的target追踪容器中</span></span><br><span class="line">    targetTracker.track(target);</span><br><span class="line">    <span class="comment">//运行request</span></span><br><span class="line">    requestTracker.runRequest(request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li><code>TargetTracker</code> : 保留当前对有效的一组Target，并转发生命周期事件。</li>
<li><code>RequestTracker</code> ：用于跟踪，取消和重新启动进行中，已完成和失败的请求的类。</li>
</ul>
</blockquote>
<p><code>Request</code> 已经讲述了一部分了，之前 <code>RequestManger</code> 部分对于 <code>Request</code> 的请求、清除、暂停、重新启动没有详细讲述，现在可以开始。</p>
<h3 id="Request-begin"><a href="#Request-begin" class="headerlink" title="Request.begin"></a>Request.begin</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.bumptech.glide.manager.RequestTracker</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runRequest</span><span class="params">(@NonNull Request request)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//添加到请求容器中</span></span><br><span class="line">    requests.add(request);</span><br><span class="line">    <span class="comment">//如果当前的RequestManager不处于暂停状态，那么直接开始请求</span></span><br><span class="line">    <span class="keyword">if</span> (!isPaused) &#123;</span><br><span class="line">        request.begin();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//否则延迟该请求</span></span><br><span class="line">        request.clear();</span><br><span class="line">        <span class="keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</span><br><span class="line">            Log.v(TAG, <span class="string">"Paused, delaying request"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">         pendingRequests.add(request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来看<code>SingleRequest</code> 的 <code>begin</code> 方法，开始真正的获取资源。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.bumptech.glide.manager.RequestTracker</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">begin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (requestLock) &#123;</span><br><span class="line">        assertNotCallingCallbacks();<span class="comment">//如果已经进行了回调，那么抛异常</span></span><br><span class="line">        stateVerifier.throwIfRecycled();<span class="comment">//如果任务已经被回收，那么抛异常</span></span><br><span class="line">        startTime = LogTime.getLogTime();</span><br><span class="line">        <span class="keyword">if</span> (model == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//校验宽高是否有效</span></span><br><span class="line">            <span class="keyword">if</span> (Util.isValidDimensions(overrideWidth, overrideHeight)) &#123;</span><br><span class="line">                width = overrideWidth;</span><br><span class="line">                height = overrideHeight;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//详细的日志级别进行记录</span></span><br><span class="line">            <span class="keyword">int</span> logLevel = getFallbackDrawable() == <span class="keyword">null</span> ? Log.WARN : Log.DEBUG;</span><br><span class="line">            onLoadFailed(<span class="keyword">new</span> GlideException(<span class="string">"Received null model"</span>), logLevel);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (status == Status.RUNNING) &#123;<span class="comment">//如果任务已经处于运行状态，那么抛异常</span></span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Cannot restart a running request"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果任务已经执行完成，那么直接回调加载资源</span></span><br><span class="line">        <span class="keyword">if</span> (status == Status.COMPLETE) &#123;</span><br><span class="line">            onResourceReady(resource, DataSource.MEMORY_CACHE);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//重新启动既未完成也未运行的请求，可以视为新请求并可以从头开始再次运行。</span></span><br><span class="line">        status = Status.WAITING_FOR_SIZE;</span><br><span class="line">        <span class="keyword">if</span> (Util.isValidDimensions(overrideWidth, overrideHeight)) &#123;</span><br><span class="line">           onSizeReady(overrideWidth, overrideHeight);<span class="comment">//内部有请求资源的实现方法调用</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           target.getSize(<span class="keyword">this</span>);<span class="comment">//重新回调onSizeReady方法</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//加载占位图</span></span><br><span class="line">        <span class="keyword">if</span> ((status == Status.RUNNING || status == Status.WAITING_FOR_SIZE)</span><br><span class="line">            &amp;&amp; canNotifyStatusChanged()) &#123;</span><br><span class="line">            target.onLoadStarted(getPlaceholderDrawable());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>已知加载的<code>ViewTarget</code>的宽高才会进一步加载资源。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.bumptech.glide.request.SingleRequest</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSizeReady</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">    stateVerifier.throwIfRecycled();<span class="comment">//如果任务已经被回收，那么抛异常</span></span><br><span class="line">    <span class="keyword">synchronized</span> (requestLock) &#123;<span class="comment">//加锁，进行数据请求</span></span><br><span class="line">        <span class="keyword">if</span> (status != Status.WAITING_FOR_SIZE) &#123;<span class="comment">//必须size确定</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        status = Status.RUNNING;<span class="comment">//进入运行状态</span></span><br><span class="line">        <span class="comment">//在加载资源之前，对Target的大小应用乘数。对于加载缩略图或避免加载大量资源非常有用。默认为1f。</span></span><br><span class="line">        <span class="keyword">float</span> sizeMultiplier = requestOptions.getSizeMultiplier();</span><br><span class="line">        <span class="keyword">this</span>.width = maybeApplySizeMultiplier(width, sizeMultiplier);</span><br><span class="line">        <span class="keyword">this</span>.height = maybeApplySizeMultiplier(height, sizeMultiplier);</span><br><span class="line">        loadStatus =</span><br><span class="line">                engine.load(</span><br><span class="line">                        glideContext,</span><br><span class="line">                        model,<span class="comment">//myUrl</span></span><br><span class="line">                        requestOptions.getSignature(),<span class="comment">//缓存签名，默认为EmptySignature</span></span><br><span class="line">                        <span class="keyword">this</span>.width,</span><br><span class="line">                        <span class="keyword">this</span>.height,</span><br><span class="line">                        requestOptions.getResourceClass(),<span class="comment">//不设置decode的话，默认为Object</span></span><br><span class="line">                        transcodeClass,<span class="comment">//Drawable.class</span></span><br><span class="line">                        priority,</span><br><span class="line">                        requestOptions.getDiskCacheStrategy(),</span><br><span class="line">                        requestOptions.getTransformations(),</span><br><span class="line">                        requestOptions.isTransformationRequired(),</span><br><span class="line">                        requestOptions.isScaleOnlyOrNoTransform(),</span><br><span class="line">                        requestOptions.getOptions(),</span><br><span class="line">                        requestOptions.isMemoryCacheable(),</span><br><span class="line">                        requestOptions.getUseUnlimitedSourceGeneratorsPool(),</span><br><span class="line">                        requestOptions.getUseAnimationPool(),</span><br><span class="line">                        requestOptions.getOnlyRetrieveFromCache(),</span><br><span class="line">                        <span class="keyword">this</span>,</span><br><span class="line">                        callbackExecutor);</span><br><span class="line">        <span class="comment">/***部分代码省略***/</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Engine-load"><a href="#Engine-load" class="headerlink" title="Engine.load"></a>Engine.load</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.bumptech.glide.load.engine.Engine</span></span><br><span class="line"><span class="keyword">public</span> &lt;R&gt; <span class="function">LoadStatus <span class="title">load</span><span class="params">(<span class="comment">/***部分代码省略***/</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> startTime = VERBOSE_IS_LOGGABLE ? LogTime.getLogTime() : <span class="number">0</span>;</span><br><span class="line">    EngineKey key = <span class="comment">//构造缓存的key</span></span><br><span class="line">            keyFactory.buildKey(</span><br><span class="line">                    model,<span class="comment">//数据myUrl</span></span><br><span class="line">                    signature,<span class="comment">//签名</span></span><br><span class="line">                    width,</span><br><span class="line">                    height,</span><br><span class="line">                    transformations,<span class="comment">//转变</span></span><br><span class="line">                    resourceClass,<span class="comment">//Object.class</span></span><br><span class="line">                    transcodeClass,<span class="comment">//Drawable.class</span></span><br><span class="line">                    options);</span><br><span class="line">    EngineResource&lt;?&gt; memoryResource;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">//先从缓存中加载</span></span><br><span class="line">        memoryResource = loadFromMemory(key, isMemoryCacheable, startTime);</span><br><span class="line">        <span class="keyword">if</span> (memoryResource == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> waitForExistingOrStartNewJob(<span class="comment">/***部分代码省略***/</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//回调可以并发，不需要进行锁操作</span></span><br><span class="line">    cb.onResourceReady(memoryResource, DataSource.MEMORY_CACHE);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="内存缓存加载"><a href="#内存缓存加载" class="headerlink" title="内存缓存加载"></a>内存缓存加载</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> EngineResource&lt;?&gt; loadFromMemory(EngineKey key, <span class="keyword">boolean</span> isMemoryCacheable, <span class="keyword">long</span> startTime) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isMemoryCacheable) &#123;<span class="comment">//如果不允许使用内存，那么直接返回null</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    EngineResource&lt;?&gt; active = loadFromActiveResources(key);<span class="comment">//获取活跃的资源</span></span><br><span class="line">    <span class="keyword">if</span> (active != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> active;</span><br><span class="line">    &#125;</span><br><span class="line">    EngineResource&lt;?&gt; cached = loadFromCache(key);<span class="comment">//获取内存缓存中的资源</span></span><br><span class="line">    <span class="keyword">if</span> (cached != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> cached;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ActiveResources"><a href="#ActiveResources" class="headerlink" title="ActiveResources"></a>ActiveResources</h4><blockquote>
<p><code>ActiveResources</code> ：利用持有<code>Resource</code> 弱引用的 <code>HashMap</code> 来进行数据保存。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> EngineResource&lt;?&gt; loadFromActiveResources(Key key) &#123;</span><br><span class="line">    EngineResource&lt;?&gt; active = activeResources.get(key);</span><br><span class="line">    <span class="keyword">if</span> (active != <span class="keyword">null</span>) &#123;</span><br><span class="line">        active.acquire();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> active;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>添加操作：有两个触发点，一个是从 <code>cache</code> 中读取的时候会将资源添加到 <code>ActiveResources</code> 。另一个获取资源完成的时候会添加到 <code>ActiveResources</code> 。它们有一个相同的点都在使用资源的时候添加到 <code>ActiveRsources</code> 。</li>
<li>删除操作：<code>EngineResource</code> 在内部有一个引用计数器，每次被获取的时候都会进行 <code>acquire</code> 自加。被释放的时候也是会自减。当引用计数为0的时候，会被 <code>ActivityResources</code> 释放，并添加到 <code>MemoryCache</code> 中。</li>
</ul>
<h4 id="MemoryCache"><a href="#MemoryCache" class="headerlink" title="MemoryCache"></a>MemoryCache</h4><blockquote>
<p><code>MemoryCache</code> ：同样使用 <strong>LRU 算法</strong>，实现类为<code>LruResourceCache</code> ，它提供了一个 <code>ResourceRemovedListener</code>接口，当有资源从 <code>MemoryCache</code> 中被移除时会回调其中的方法，<code>Engine</code> 中接收到这个消息后就会进行 <code>Bitmap</code> 的回收操作。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> EngineResource&lt;?&gt; loadFromCache(Key key) &#123;</span><br><span class="line">    EngineResource&lt;?&gt; cached = getEngineResourceFromCache(key);</span><br><span class="line">    <span class="keyword">if</span> (cached != <span class="keyword">null</span>) &#123;</span><br><span class="line">        cached.acquire();</span><br><span class="line">        activeResources.activate(key, cached);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cached;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> EngineResource&lt;?&gt; getEngineResourceFromCache(Key key) &#123;</span><br><span class="line">    Resource&lt;?&gt; cached = cache.remove(key);</span><br><span class="line">    <span class="keyword">final</span> EngineResource&lt;?&gt; result;</span><br><span class="line">    <span class="keyword">if</span> (cached == <span class="keyword">null</span>) &#123;</span><br><span class="line">        result = <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cached <span class="keyword">instanceof</span> EngineResource) &#123;</span><br><span class="line">        result = (EngineResource&lt;?&gt;) cached;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        result = <span class="keyword">new</span> EngineResource&lt;&gt;(cached, <span class="keyword">true</span>, <span class="keyword">true</span>, key, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResourceReleased</span><span class="params">(Key cacheKey, EngineResource&lt;?&gt; resource)</span> </span>&#123;</span><br><span class="line">    activeResources.deactivate(cacheKey);</span><br><span class="line">    <span class="keyword">if</span> (resource.isMemoryCacheable()) &#123;</span><br><span class="line">        cache.put(cacheKey, resource);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        resourceRecycler.recycle(resource);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>添加操作：当资源被 <code>ActiveResources</code> 释放的时候；</li>
<li>删除操作：当资源被 <code>ActivityResource</code> 获取的时候；</li>
</ul>
<p>以上两点保证了 <code>ActiveResource</code> 和 <code>MemoryCache</code> 中的资源是不会有重复的。</p>
<h3 id="DecodeJob"><a href="#DecodeJob" class="headerlink" title="DecodeJob"></a>DecodeJob</h3><blockquote>
<p><code>DecodeJob</code> ：负责从缓存的数据或原始源解码资源，并应用转换和转码。<br>接下来的部分会详细讲解上图的每个部分。</p>
</blockquote>
<center><img src="https://img-blog.csdnimg.cn/20191220190409636.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9kYW5kYW5sb3ZlLmJsb2cuY3Nkbi5uZXQ=,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></center>

<h3 id="磁盘缓存加载"><a href="#磁盘缓存加载" class="headerlink" title="磁盘缓存加载"></a>磁盘缓存加载</h3><p>等待创建或者是获取已经存在的加载状态。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;R&gt; <span class="function">LoadStatus <span class="title">waitForExistingOrStartNewJob</span><span class="params">(<span class="comment">/***部分代码省略***/</span>)</span> </span>&#123;</span><br><span class="line">    EngineJob&lt;?&gt; current = jobs.get(key, onlyRetrieveFromCache);<span class="comment">//从hashmap中获取加载key的工作引擎</span></span><br><span class="line">    <span class="keyword">if</span> (current != <span class="keyword">null</span>) &#123;<span class="comment">//如果已经存在那么直接返回</span></span><br><span class="line">        current.addCallback(cb, callbackExecutor);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LoadStatus(cb, current);</span><br><span class="line">    &#125;</span><br><span class="line">    EngineJob&lt;R&gt; engineJob = <span class="comment">//通过添加和删除负载的回调并在负载完成时通知回调来管理负载的类。</span></span><br><span class="line">            engineJobFactory.build(<span class="comment">/***部分代码省略***/</span>);</span><br><span class="line">    DecodeJob&lt;R&gt; decodeJob = <span class="comment">//负责从缓存的数据或原始源解码资源，并应用转换和转码。</span></span><br><span class="line">            decodeJobFactory.build(<span class="comment">/***部分代码省略***/</span>);</span><br><span class="line">    jobs.put(key, engineJob);<span class="comment">//添加到hashmap中</span></span><br><span class="line">    engineJob.addCallback(cb, callbackExecutor);<span class="comment">//添加回调信息</span></span><br><span class="line">    engineJob.start(decodeJob);<span class="comment">//开始工作</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> LoadStatus(cb, engineJob);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>选择执行线程，开始执行任务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.bumptech.glide.load.engine.EngineJob</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(DecodeJob&lt;R&gt; decodeJob)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.decodeJob = decodeJob;</span><br><span class="line">    <span class="comment">//根据磁盘缓存策略，判断使用哪个线程池执行任务</span></span><br><span class="line">    GlideExecutor executor = decodeJob.willDecodeFromCache() ? diskCacheExecutor : getActiveSourceExecutor();</span><br><span class="line">    executor.execute(decodeJob);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>diskCacheExecutor</code> 线程池中执行 <code>DecoceJob</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.bumptech.glide.load.engine.DecodeJob</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">/***部分代码省略***/</span></span><br><span class="line">    DataFetcher&lt;?&gt; localFetcher = currentFetcher;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (isCancelled) &#123;<span class="comment">//如果任务已经取消，那么进行失败回调</span></span><br><span class="line">            notifyFailed();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        runWrapped();<span class="comment">//开始执行任务</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (CallbackException e) &#123;</span><br><span class="line">        <span class="comment">//如果不受Glide控制的回调引发异常，则应避免使用Glide下面的特定调试逻辑。 </span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        <span class="comment">//通知失败，进行失败回调，抛出异常</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (localFetcher != <span class="keyword">null</span>) &#123;</span><br><span class="line">            localFetcher.cleanup();</span><br><span class="line">        &#125;</span><br><span class="line">        GlideTrace.endSection();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>runWrapped</code> 为 <code>run</code> 实现的包装。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.bumptech.glide.load.engine.DecodeJob</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">enum</span> RunReason &#123;</span><br><span class="line">    <span class="comment">//初始化</span></span><br><span class="line">    INITIALIZE,</span><br><span class="line">    <span class="comment">//切换执行服务</span></span><br><span class="line">    SWITCH_TO_SOURCE_SERVICE,</span><br><span class="line">    <span class="comment">//获取数据之后的资源编解码</span></span><br><span class="line">    DECODE_DATA,</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">runWrapped</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (runReason) &#123;</span><br><span class="line">        <span class="keyword">case</span> INITIALIZE:</span><br><span class="line">            stage = getNextStage(Stage.INITIALIZE);</span><br><span class="line">            currentGenerator = getNextGenerator();</span><br><span class="line">            runGenerators();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SWITCH_TO_SOURCE_SERVICE:</span><br><span class="line">            runGenerators();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> DECODE_DATA:</span><br><span class="line">            decodeFromRetrievedData();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unrecognized run reason: "</span> + runReason);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再讲下一步数据从磁盘的获取之前，先看一下我们默认的磁盘策略：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> DiskCacheStrategy AUTOMATIC =</span><br><span class="line">    <span class="keyword">new</span> DiskCacheStrategy() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isDataCacheable</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> dataSource == DataSource.REMOTE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isResourceCacheable</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> isFromAlternateCacheKey, DataSource dataSource, EncodeStrategy encodeStrategy)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> ((isFromAlternateCacheKey &amp;&amp; dataSource == DataSource.DATA_DISK_CACHE)</span><br><span class="line">                    || dataSource == DataSource.LOCAL)</span><br><span class="line">                &amp;&amp; encodeStrategy == EncodeStrategy.TRANSFORMED;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">decodeCachedResource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">decodeCachedData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>如果数据时 <code>REMOTE</code> 类型那么可以进行缓存；</li>
<li>如果是解码资源而且<code>Key</code> 不是源数据的<code>Key</code> ，资源为 <code>DATA_DISK_CACHE</code> 的话，那么这个资源可以缓存；</li>
<li>可以缓存解码资源；</li>
<li>可以缓存解码数据；</li>
</ul>
<p>从上面我们可以了解到缓存有<code>数据缓存</code> 和 <code>解码后的数据缓存</code> 。</p>
<p>我们接着分析 <code>runWrapped</code> 方法内调用的 <code>getNextStage</code> :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.bumptech.glide.load.engine.DecodeJob</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Stage <span class="title">getNextStage</span><span class="params">(Stage current)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (current) &#123;</span><br><span class="line">        <span class="keyword">case</span> INITIALIZE:<span class="comment">//AUTOMATIC默认为true，所以初始化的第一步应该检测Stage.RESOURCE_CACHE</span></span><br><span class="line">            <span class="keyword">return</span> diskCacheStrategy.decodeCachedResource()</span><br><span class="line">                ? Stage.RESOURCE_CACHE</span><br><span class="line">                : getNextStage(Stage.RESOURCE_CACHE);</span><br><span class="line">        <span class="keyword">case</span> RESOURCE_CACHE:<span class="comment">//AUTOMATIC默认为true，所以初始化的下一步应该检测Stage.DATA_CACHE</span></span><br><span class="line">            <span class="keyword">return</span> diskCacheStrategy.decodeCachedData()</span><br><span class="line">                ? Stage.DATA_CACHE</span><br><span class="line">                : getNextStage(Stage.DATA_CACHE);</span><br><span class="line">        <span class="keyword">case</span> DATA_CACHE:<span class="comment">////如果用户选择仅从缓存中检索资源，则从源跳过加载。否则应该检测Stage.SOURCE</span></span><br><span class="line">            <span class="keyword">return</span> onlyRetrieveFromCache ? Stage.FINISHED : Stage.SOURCE;</span><br><span class="line">        <span class="keyword">case</span> SOURCE:</span><br><span class="line">        <span class="keyword">case</span> FINISHED:</span><br><span class="line">            <span class="keyword">return</span> Stage.FINISHED;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unrecognized stage: "</span> + current);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>知道了<code>Stage</code> 类型接着分析 <code>runWrapped</code> 方法内调用的 <code>getNextStage</code> :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.bumptech.glide.load.engine.DecodeJob</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> DataFetcherGenerator <span class="title">getNextGenerator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (stage) &#123;</span><br><span class="line">        <span class="keyword">case</span> RESOURCE_CACHE:<span class="comment">//解码之后的资源缓存</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ResourceCacheGenerator(decodeHelper, <span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">case</span> DATA_CACHE:<span class="comment">//源数据的缓存</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> DataCacheGenerator(decodeHelper, <span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">case</span> SOURCE:<span class="comment">//数据源</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SourceGenerator(decodeHelper, <span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">case</span> FINISHED:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unrecognized stage: "</span> + stage);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>DataFetcherGenerator</code> : 注册 <code>ModelLoaders</code> 和 <code>Model</code> 的数据提取构造器。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">DataFetcherGenerator</span> </span>&#123;</span><br><span class="line">    <span class="comment">//尝试使用一个新的DataFetcher，则返回true已启动，否则为false。</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">startNext</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//尝试取消当前正在运行的提取程序</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">cancel</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ResourceCacheGenerator</code> 、<code>DataCacheGenerator</code> 和 <code>SourceGenerator</code> 除过实现了<code>DataFetcherGenerator</code> 还实现了 <code>DataCallback</code> 接口。</p>
<blockquote>
<p><code>DataCallback</code> : 数据已加载且可用时或加载时必须调用的回调失败。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">DataCallback</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">//如果加载成功，则使用加载的数据进行调用；如果加载失败，则使用null进行调用。</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onDataReady</span><span class="params">(@Nullable T data)</span></span>;</span><br><span class="line">    <span class="comment">//加载失败时调用</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onLoadFailed</span><span class="params">(@NonNull Exception e)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获取到<code>DataFetcherGenerator</code> 构造器之后执行 <code>startNext</code> ，判断是否下一步能开始加载数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.bumptech.glide.load.engine.EngineJob</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">runGenerators</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    currentThread = Thread.currentThread();</span><br><span class="line">    startFetchTime = LogTime.getLogTime();</span><br><span class="line">    <span class="keyword">boolean</span> isStarted = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">while</span> (!isCancelled &amp;&amp; currentGenerator != <span class="keyword">null</span> </span><br><span class="line">        &amp;&amp; !(isStarted = currentGenerator.startNext())) &#123;<span class="comment">//执行当前数据构造的判断是否能加载数据</span></span><br><span class="line">        stage = getNextStage(stage);<span class="comment">//切换数据状态</span></span><br><span class="line">        currentGenerator = getNextGenerator();<span class="comment">//获取新的数据构造器</span></span><br><span class="line">        <span class="keyword">if</span> (stage == Stage.SOURCE) &#123;<span class="comment">//需要需要进行源数据加载那么切换执行线程</span></span><br><span class="line">            reschedule();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//如果已经完成或者取消，而且没开始获取数据。那么通知失败</span></span><br><span class="line">    <span class="keyword">if</span> ((stage == Stage.FINISHED || isCancelled) &amp;&amp; !isStarted) &#123;</span><br><span class="line">        notifyFailed();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//否则，生成器将开始新的加载，我们希望将其调回onDataFetcherReady。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ResourceCacheGenerator"><a href="#ResourceCacheGenerator" class="headerlink" title="ResourceCacheGenerator"></a>ResourceCacheGenerator</h4><blockquote>
<p><code>ResourceCacheGenerator</code> ：从包含降采样/转换后的资源缓存文件中获取数据。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResourceCacheGenerator</span> <span class="keyword">implements</span> <span class="title">DataFetcherGenerator</span>, <span class="title">DataFetcher</span>.<span class="title">DataCallback</span>&lt;<span class="title">Object</span>&gt; </span>&#123;    </span><br><span class="line">    <span class="comment">/***部分代码省略***/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">startNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;Key&gt; sourceIds = helper.getCacheKeys();<span class="comment">//能处理Model（myUrl）的LoadData列表，返回其Key</span></span><br><span class="line">        <span class="keyword">if</span> (sourceIds.isEmpty()) &#123;<span class="comment">//如果没有，那么标示Model（myUrl）这个数据类型无法处理，直接返回false</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取glide中注册的，能加载Model（url），能解码resourceClass（Drawable），能转码transcodeClass(Object)的组件集合</span></span><br><span class="line">        List&lt;Class&lt;?&gt;&gt; resourceClasses = helper.getRegisteredResourceClasses();</span><br><span class="line">        <span class="keyword">if</span> (resourceClasses.isEmpty()) &#123;<span class="comment">//如果没有适配的组件集合，而且转码的类型为文件的话那么抛异常。因为File都不能转码那么根本无法磁盘缓存</span></span><br><span class="line">            <span class="keyword">if</span> (File.class.equals(helper.getTranscodeClass())) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="comment">/***部分代码省略***/</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (modelLoaders == <span class="keyword">null</span> || !hasNextModelLoader()) &#123;<span class="comment">//如果还有modelLoader</span></span><br><span class="line">            resourceClassIndex++;</span><br><span class="line">            <span class="comment">//双重判断使LoadData列表进行完全遍历</span></span><br><span class="line">            <span class="keyword">if</span> (resourceClassIndex &gt;= resourceClasses.size()) &#123;</span><br><span class="line">                sourceIdIndex++;</span><br><span class="line">                <span class="keyword">if</span> (sourceIdIndex &gt;= sourceIds.size()) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                resourceClassIndex = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            Key sourceId = sourceIds.get(sourceIdIndex);</span><br><span class="line">            Class&lt;?&gt; resourceClass = resourceClasses.get(resourceClassIndex);</span><br><span class="line">            Transformation&lt;?&gt; transformation = helper.getTransformation(resourceClass);</span><br><span class="line">            <span class="comment">//ResourceCacheKey用于下采样和转换的资源数据的缓存密钥+任何请求的签名。</span></span><br><span class="line">            currentKey =</span><br><span class="line">                <span class="keyword">new</span> ResourceCacheKey(</span><br><span class="line">                    helper.getArrayPool(),</span><br><span class="line">                    sourceId,<span class="comment">//modelLoaddata</span></span><br><span class="line">                    helper.getSignature(),<span class="comment">//签名</span></span><br><span class="line">                    helper.getWidth(),<span class="comment">//宽</span></span><br><span class="line">                    helper.getHeight(),<span class="comment">//高</span></span><br><span class="line">                    transformation,<span class="comment">//转换</span></span><br><span class="line">                    resourceClass,<span class="comment">//解码</span></span><br><span class="line">                    helper.getOptions());</span><br><span class="line">            cacheFile = helper.getDiskCache().get(currentKey);</span><br><span class="line">            <span class="comment">//判断Resource是否有缓存，如果有那么加载这个缓存文件数据</span></span><br><span class="line">            <span class="keyword">if</span> (cacheFile != <span class="keyword">null</span>) &#123;</span><br><span class="line">                sourceKey = sourceId;</span><br><span class="line">                modelLoaders = helper.getModelLoaders(cacheFile);<span class="comment">//获取能加载文件的ModelLoader列表</span></span><br><span class="line">                modelLoaderIndex = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        loadData = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">boolean</span> started = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">while</span> (!started &amp;&amp; hasNextModelLoader()) &#123;</span><br><span class="line">            ModelLoader&lt;File, ?&gt; modelLoader = modelLoaders.get(modelLoaderIndex++);</span><br><span class="line">            <span class="comment">//ModelLoader根据cacheFile，width，height，options构造LoadData</span></span><br><span class="line">            loadData = modelLoader.buildLoadData(cacheFile, helper.getWidth(), helper.getHeight(), helper.getOptions());</span><br><span class="line">            <span class="comment">//该LoadData是否被Glide进行加载过，是否可用</span></span><br><span class="line">            <span class="keyword">if</span> (loadData != <span class="keyword">null</span> &amp;&amp; helper.hasLoadPath(loadData.fetcher.getDataClass())) &#123;</span><br><span class="line">                started = <span class="keyword">true</span>;<span class="comment">//如果可用，那么使用该LoadData中的DataFetcher进行数据获取</span></span><br><span class="line">                loadData.fetcher.loadData(helper.getPriority(), <span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> started;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        LoadData&lt;?&gt; local = loadData;</span><br><span class="line">        <span class="keyword">if</span> (local != <span class="keyword">null</span>) &#123;</span><br><span class="line">            local.fetcher.cancel();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span><span class="comment">//数据已经准备好，标识数据源为RESOURCE_DISK_CACHE</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDataReady</span><span class="params">(Object data)</span> </span>&#123;</span><br><span class="line">        cb.onDataFetcherReady(</span><br><span class="line">            sourceKey, data, loadData.fetcher, DataSource.RESOURCE_DISK_CACHE, currentKey);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span><span class="comment">//加载失败，标识数据源为RESOURCE_DISK_CACHE</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLoadFailed</span><span class="params">(@NonNull Exception e)</span> </span>&#123;</span><br><span class="line">        cb.onDataFetcherFailed(currentKey, e, loadData.fetcher, DataSource.RESOURCE_DISK_CACHE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="DataCacheGenerator"><a href="#DataCacheGenerator" class="headerlink" title="DataCacheGenerator"></a>DataCacheGenerator</h4><blockquote>
<p><code>DataCacheGenerator</code> ： 构造来自包含原始未修改源数据的缓存文件。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DataCacheGenerator</span> <span class="keyword">implements</span> <span class="title">DataFetcherGenerator</span>, <span class="title">DataFetcher</span>.<span class="title">DataCallback</span>&lt;<span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">/***部分代码省略***/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">startNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//如果还有modelLoader</span></span><br><span class="line">        <span class="keyword">while</span> (modelLoaders == <span class="keyword">null</span> || !hasNextModelLoader()) &#123;</span><br><span class="line">            sourceIdIndex++;</span><br><span class="line">            <span class="comment">//cacheKyes（helper.getCacheKeys）在构造的时候传入，和ResourceCacheGenerator的相同</span></span><br><span class="line">            <span class="keyword">if</span> (sourceIdIndex &gt;= cacheKeys.size()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            Key sourceId = cacheKeys.get(sourceIdIndex);</span><br><span class="line">            <span class="comment">//原始源数据的缓存键和任何请求的签名。</span></span><br><span class="line">            Key originalKey = <span class="keyword">new</span> DataCacheKey(sourceId, helper.getSignature());</span><br><span class="line">            cacheFile = helper.getDiskCache().get(originalKey);</span><br><span class="line">            <span class="comment">//判断Resource是否有缓存，如果有那么加载这个缓存文件数据</span></span><br><span class="line">            <span class="keyword">if</span> (cacheFile != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">this</span>.sourceKey = sourceId;</span><br><span class="line">                modelLoaders = helper.getModelLoaders(cacheFile);<span class="comment">//获取能加载文件的ModelLoader列表</span></span><br><span class="line">                modelLoaderIndex = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        loadData = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">boolean</span> started = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">while</span> (!started &amp;&amp; hasNextModelLoader()) &#123;</span><br><span class="line">            ModelLoader&lt;File, ?&gt; modelLoader = modelLoaders.get(modelLoaderIndex++);</span><br><span class="line">            <span class="comment">//ModelLoader根据cacheFile，width，height，options构造LoadData</span></span><br><span class="line">            loadData = modelLoader.buildLoadData(cacheFile, helper.getWidth(), helper.getHeight(), helper.getOptions());</span><br><span class="line">            <span class="comment">//该LoadData是否被Glide进行加载过，是否可用</span></span><br><span class="line">            <span class="keyword">if</span> (loadData != <span class="keyword">null</span> &amp;&amp; helper.hasLoadPath(loadData.fetcher.getDataClass())) &#123;</span><br><span class="line">                started = <span class="keyword">true</span>;<span class="comment">//如果可用，那么使用该LoadData中的DataFetcher进行数据获取</span></span><br><span class="line">                loadData.fetcher.loadData(helper.getPriority(), <span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> started;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDataReady</span><span class="params">(Object data)</span> </span>&#123;<span class="comment">//数据已经准备好，标识数据源为DATA_DISK_CACHE</span></span><br><span class="line">        cb.onDataFetcherReady(sourceKey, data, loadData.fetcher, DataSource.DATA_DISK_CACHE, sourceKey);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLoadFailed</span><span class="params">(@NonNull Exception e)</span> </span>&#123;<span class="comment">//加载失败，标识数据源为DATA_DISK_CACHE</span></span><br><span class="line">        cb.onDataFetcherFailed(sourceKey, e, loadData.fetcher, DataSource.DATA_DISK_CACHE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出来 <code>ResourceCacheGenerator</code> 的实现其实和 <code>DataCacheGenerator</code> 的实现逻辑很相似，只不过是缓存的 <code>Key</code> 不同而已。</p>
<h3 id="源数据请求"><a href="#源数据请求" class="headerlink" title="源数据请求"></a>源数据请求</h3><blockquote>
<p><code>SourceGenerator</code> ： 根据磁盘缓存策略，可以先将源数据编码后写入磁盘，然后再加载从缓存文件而不是直接返回。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SourceGenerator</span> <span class="keyword">implements</span> <span class="title">DataFetcherGenerator</span>,<span class="title">DataFetcher</span>.<span class="title">DataCallback</span>&lt;<span class="title">Object</span>&gt;,</span></span><br><span class="line"><span class="class">				<span class="title">DataFetcherGenerator</span>.<span class="title">FetcherReadyCallback</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> DataCacheGenerator sourceCacheGenerator;<span class="comment">//磁盘缓存的数据构造器</span></span><br><span class="line">    <span class="keyword">private</span> Object dataToCache;<span class="comment">//需要缓存的数据</span></span><br><span class="line">    <span class="keyword">private</span> DataCacheKey originalKey;<span class="comment">//磁盘缓存的key</span></span><br><span class="line">    <span class="comment">/***部分代码省略***/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">startNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (dataToCache != <span class="keyword">null</span>) &#123;<span class="comment">//是否已经拥有缓存的数据</span></span><br><span class="line">            Object data = dataToCache;</span><br><span class="line">            dataToCache = <span class="keyword">null</span>;</span><br><span class="line">            cacheData(data);<span class="comment">//进行据缓存，缓存后sourceCacheGenerator不为空</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//由SourceGenerator转到DataCacheGenerator（网络转磁盘）</span></span><br><span class="line">        <span class="keyword">if</span> (sourceCacheGenerator != <span class="keyword">null</span> &amp;&amp; sourceCacheGenerator.startNext()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        sourceCacheGenerator = <span class="keyword">null</span>;</span><br><span class="line">        loadData = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">boolean</span> started = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">while</span> (!started &amp;&amp; hasNextModelLoader()) &#123;<span class="comment">//如果还有LoadData(model,width，height，options构造LoadData)</span></span><br><span class="line">            loadData = helper.getLoadData().get(loadDataListIndex++);</span><br><span class="line">            <span class="comment">//fetcher.getDataSource()是否可以进行磁盘缓存</span></span><br><span class="line">            <span class="keyword">if</span> (loadData != <span class="keyword">null</span> &amp;&amp; (helper.getDiskCacheStrategy().isDataCacheable(loadData.fetcher.getDataSource())</span><br><span class="line">                    || helper.hasLoadPath(loadData.fetcher.getDataClass()))) &#123;<span class="comment">//该LoadData是否被Glide进行加载过，是否可用</span></span><br><span class="line">                started = <span class="keyword">true</span>;<span class="comment">//如果可用，那么使用该LoadData中的DataFetcher进行数据获取</span></span><br><span class="line">                loadData.fetcher.loadData(helper.getPriority(), <span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> started;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/***部分代码省略***/</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cacheData</span><span class="params">(Object dataToCache)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> startTime = LogTime.getLogTime();</span><br><span class="line">        <span class="keyword">try</span> &#123;<span class="comment">//获取dataToCache对应的解码器，StreamEncoder</span></span><br><span class="line">            Encoder&lt;Object&gt; encoder = helper.getSourceEncoder(dataToCache);</span><br><span class="line">            DataCacheWriter&lt;Object&gt; writer = <span class="keyword">new</span> DataCacheWriter&lt;&gt;(encoder, dataToCache, helper.getOptions());</span><br><span class="line">            originalKey = <span class="keyword">new</span> DataCacheKey(loadData.sourceKey, helper.getSignature());<span class="comment">//生成数据源的key</span></span><br><span class="line">            helper.getDiskCache().put(originalKey, writer);<span class="comment">//将writer写入到磁盘缓存中，对应的key为originalKey</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            loadData.fetcher.cleanup();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//构造原始数据缓存构造器，转到磁盘读取数据</span></span><br><span class="line">        sourceCacheGenerator = <span class="keyword">new</span> DataCacheGenerator(Collections.singletonList(loadData.sourceKey), helper, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span><span class="comment">//数据加载成功回调，date类型为InputStream</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDataReady</span><span class="params">(Object data)</span> </span>&#123;DiskCacheStrategy diskCacheStrategy = helper.getDiskCacheStrategy();</span><br><span class="line">        <span class="comment">//如果数据不为空，而且可以缓存那么机进行SourceGenerator转DataCacheGenerator</span></span><br><span class="line">        <span class="keyword">if</span> (data != <span class="keyword">null</span> &amp;&amp; diskCacheStrategy.isDataCacheable(loadData.fetcher.getDataSource())) &#123;</span><br><span class="line">            dataToCache = data;</span><br><span class="line">            cb.reschedule();<span class="comment">//切换线程，切换完之后currentGenerator还是SourceGenerator</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;<span class="comment">//否早直接将数据进行回调</span></span><br><span class="line">            cb.onDataFetcherReady(loadData.sourceKey,data,loadData.fetcher,loadData.fetcher.getDataSource(),originalKey);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span><span class="comment">//数据加载失败回调</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLoadFailed</span><span class="params">(@NonNull Exception e)</span> </span>&#123;</span><br><span class="line">        cb.onDataFetcherFailed(originalKey, e, loadData.fetcher, loadData.fetcher.getDataSource());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span><span class="comment">//DataCacheGenerator的数据加载成功回调，data类型为ByteBuffer</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDataFetcherReady</span><span class="params">(Key sourceKey, Object data, DataFetcher&lt;?&gt; fetcher, DataSource dataSource, Key attemptedKey)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 此数据提取程序将从文件中加载并提供错误的数据源，因此请覆盖使用原始提取程序的数据源 </span></span><br><span class="line">        cb.onDataFetcherReady(sourceKey, data, fetcher, loadData.fetcher.getDataSource(), sourceKey);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span><span class="comment">//DataCacheGenerator的数据加载失败回调</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDataFetcherFailed</span><span class="params">(Key sourceKey, Exception e, DataFetcher&lt;?&gt; fetcher, DataSource dataSource)</span> </span>&#123;</span><br><span class="line">        cb.onDataFetcherFailed(sourceKey, e, fetcher, loadData.fetcher.getDataSource());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>SourceGenerator</code> 、<code>DataCacheGenerator</code> 和 <code>ResourceCacheGenerator</code> 的 <code>startNext</code> 方法都会寻找合适的 <code>ModelLoader</code> 构建对应的 <code>LoadData</code> 来加载数据。</p>
<p>现在我们的 <code>Model</code> 是 <code>myUrl</code> 一个网络图片地址，在没有加载过之前<code>ResourceCacheGenerator</code> 和 <code>DataCacheGenerator</code> 当然是没有缓存的，所以我们这里用<code>SourceGenerator</code> 加载一个网络图片的过程在详细讲述一下 <code>startNext</code> 中怎么获取<code>LoadData</code> 进行数据加载（其他两个都实现都类似）。</p>
<blockquote>
<p>需要注意的是<code>Data</code>已经是从磁盘缓存读出来的 <code>ByteBuffer</code> ，但是<code>DataSource</code> 还是 <code>REMOTE</code> 。</p>
</blockquote>
<h3 id="数据解码和转码"><a href="#数据解码和转码" class="headerlink" title="数据解码和转码"></a>数据解码和转码</h3><p>无论加载的缓存还是其他的数据成功后都会回调 <code>onDataFetcherReady</code> ，然后进行数据解码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.bumptech.glide.load.engine.DecodeJob</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDataFetcherReady</span><span class="params">(Key sourceKey, Object data, DataFetcher&lt;?&gt; fetcher, DataSource dataSource, Key attemptedKey)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.currentSourceKey = sourceKey;<span class="comment">//url</span></span><br><span class="line">    <span class="keyword">this</span>.currentData = data;<span class="comment">//ByteBuffer</span></span><br><span class="line">    <span class="keyword">this</span>.currentFetcher = fetcher;<span class="comment">//ByteBufferFetcher</span></span><br><span class="line">    <span class="keyword">this</span>.currentDataSource = dataSource;<span class="comment">//REMOTE</span></span><br><span class="line">    <span class="keyword">this</span>.currentAttemptingKey = attemptedKey;<span class="comment">//url</span></span><br><span class="line">    <span class="comment">//如果当前线程不是主线程，那么切换到主线程执行数据解码（调用decodeFromRetrievedData）</span></span><br><span class="line">    <span class="keyword">if</span> (Thread.currentThread() != currentThread) &#123;</span><br><span class="line">        runReason = RunReason.DECODE_DATA;</span><br><span class="line">        callback.reschedule(<span class="keyword">this</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        GlideTrace.beginSection(<span class="string">"DecodeJob.decodeFromRetrievedData"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            decodeFromRetrievedData();<span class="comment">//进行数据解码</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            GlideTrace.endSection();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来的步骤：</p>
<ol>
<li><code>decodeFromRetrievedData</code> 中调用 <code>decodeFromData</code> ；</li>
<li><code>decodeFromData</code> 中调用 <code>decodeFromFetcher</code> ；</li>
<li><code>decodeFromFetcher</code> 获取 <code>Registry.getLoadPath</code>  以及 <code>Registry.getRewinder</code>；</li>
</ol>
<p>最终是为了获得 <code>DecodePaht</code> 和 <code>LoadPath</code> 。</p>
<h4 id="解码-amp-渐变-amp-转码"><a href="#解码-amp-渐变-amp-转码" class="headerlink" title="解码&amp;渐变&amp;转码"></a>解码&amp;渐变&amp;转码</h4><blockquote>
<p><code>LoadPath</code> ：一个或多个 <code>DecodePath</code> 来进行数据的解码；</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.bumptech.glide.Registry</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">public</span> &lt;Data, TResource, Transcode&gt; <span class="function">LoadPath&lt;Data, TResource, Transcode&gt; <span class="title">getLoadPath</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      @NonNull Class&lt;Data&gt; dataClass,//ByteBuffer.class</span></span></span><br><span class="line"><span class="function"><span class="params">      @NonNull Class&lt;TResource&gt; resourceClass,//Object.class</span></span></span><br><span class="line"><span class="function"><span class="params">      @NonNull Class&lt;Transcode&gt; transcodeClass)</span> </span>&#123;<span class="comment">//Drawable.class</span></span><br><span class="line">    LoadPath&lt;Data, TResource, Transcode&gt; result = loadPathCache.get(dataClass, resourceClass, transcodeClass);</span><br><span class="line">    <span class="keyword">if</span> (loadPathCache.isEmptyLoadPath(result)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</span><br><span class="line">        List&lt;DecodePath&lt;Data, TResource, Transcode&gt;&gt; decodePaths = getDecodePaths(dataClass, resourceClass, transcodeClass);</span><br><span class="line">        <span class="comment">//可能无法将给定的类型解码或转码为所需的类型数据类。 </span></span><br><span class="line">        <span class="keyword">if</span> (decodePaths.isEmpty()) &#123;</span><br><span class="line">            result = <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            result = <span class="keyword">new</span> LoadPath&lt;&gt;(dataClass, resourceClass, transcodeClass, decodePaths, throwableListPool);</span><br><span class="line">        &#125;</span><br><span class="line">        loadPathCache.put(dataClass, resourceClass, transcodeClass, result);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>DecodePath</code> ：尝试从给定的数据类型解码和转码资源类型；</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.bumptech.glide.Registry</span></span><br><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="keyword">private</span> &lt;Data, TResource, Transcode&gt; List&lt;DecodePath&lt;Data, TResource, Transcode&gt;&gt; getDecodePaths(</span><br><span class="line">      <span class="meta">@NonNull</span> Class&lt;Data&gt; dataClass,</span><br><span class="line">      <span class="meta">@NonNull</span> Class&lt;TResource&gt; resourceClass,</span><br><span class="line">      <span class="meta">@NonNull</span> Class&lt;Transcode&gt; transcodeClass) &#123;</span><br><span class="line">    List&lt;DecodePath&lt;Data, TResource, Transcode&gt;&gt; decodePaths = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="comment">//GifDrawable,Bitmap,BitmapDrawable</span></span><br><span class="line">    List&lt;Class&lt;TResource&gt;&gt; registeredResourceClasses = decoderRegistry.getResourceClasses(dataClass, resourceClass);</span><br><span class="line">    <span class="keyword">for</span> (Class&lt;TResource&gt; registeredResourceClass : registeredResourceClasses) &#123;</span><br><span class="line">        List&lt;Class&lt;Transcode&gt;&gt; registeredTranscodeClasses = transcoderRegistry.getTranscodeClasses(registeredResourceClass, transcodeClass);</span><br><span class="line">        <span class="keyword">for</span> (Class&lt;Transcode&gt; registeredTranscodeClass : registeredTranscodeClasses) &#123;</span><br><span class="line">            List&lt;ResourceDecoder&lt;Data, TResource&gt;&gt; decoders = decoderRegistry.getDecoders(dataClass, registeredResourceClass);</span><br><span class="line">            ResourceTranscoder&lt;TResource, Transcode&gt; transcoder = transcoderRegistry.get(registeredResourceClass, registeredTranscodeClass);</span><br><span class="line">            <span class="comment">//transcoder=DrawableBytesTranscoder</span></span><br><span class="line">            DecodePath&lt;Data, TResource, Transcode&gt; path =</span><br><span class="line">                <span class="keyword">new</span> DecodePath&lt;&gt;(</span><br><span class="line">                    dataClass,<span class="comment">//ByteBuffer</span></span><br><span class="line">                    registeredResourceClass,<span class="comment">//GifDrawable/Bitmap/BitmapDrawable</span></span><br><span class="line">                    registeredTranscodeClass,<span class="comment">//Drawable/Drawable/Drawable</span></span><br><span class="line">              			<span class="comment">//ByteBufferGifDecoder/ByteBufferBitmapDecoder/BitmapDrawableDecoder</span></span><br><span class="line">                    decoders,</span><br><span class="line">              			<span class="comment">///UnitTranscoder/BitmapDrawableTranscoder/UnitTranscoder</span></span><br><span class="line">                    transcoder,</span><br><span class="line">                    throwableListPool);</span><br><span class="line">            decodePaths.add(path);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> decodePaths;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>解码的时候调用 <code>DecodePath.decode</code> 方法，该方法会循环遍历内部的<code>decoders</code>列表中的 <code>ResourceDecoder</code> 如果<code>ByteBufferBitmapDecoder.decode</code>解码成功(<code>Bitmap</code>)直接返回。</li>
<li>继续回调判断是或否进行<code>transform</code> 如果需要那么 <code>DecodeJob.onResourceDecoded</code> 进行 <code>transform</code> 进行资源的渐变，渐变之后重新构造缓存的 <code>Key</code> 将再次进行 <code>Encoder</code> 。</li>
<li>然后再进行 <code>BitmapDrawableTranscoder.transcode</code> 进行转码得到 <code>LazyBitmapDrawableResource</code> 。</li>
<li>回到 <code>notifyEncodeAndRelease</code> 方法进行资源成功回调，以及判断判断是否需要 <code>Encoder</code> 进行磁盘缓存，回调编码成功释放资源。</li>
</ol>
<center><img src="https://img-blog.csdnimg.cn/20191220192134589.png#pic_center" alt="在这里插入图片描述"></center>

<p>至此整个资源的获取过程完成，最后我们获取出了<code>Drawable</code> 。</p>
<h3 id="加载-amp-释放资源"><a href="#加载-amp-释放资源" class="headerlink" title="加载&amp;释放资源"></a>加载&amp;释放资源</h3><blockquote>
<p><code>DecodeJob</code></p>
</blockquote>
<ul>
<li><p>进行 <code>notifyComplete</code> : 回调 <code>EngineJob.onResourceReady</code> ;</p>
</li>
<li><p>进行 <code>onEncodeComplete</code> ：释放当前的 <code>DecodeJob</code> ;</p>
</li>
</ul>
<blockquote>
<p><code>EngineJob</code></p>
</blockquote>
<ul>
<li>进行 <code>notifyCallbacksOfResult</code> ，回调 <code>incrementPendingCallbacks</code> 进行资源的引用+1 ；</li>
<li>回调 <code>Engine.onEngineJobComplete</code> ；</li>
<li>执行 <code>CallResourceReady</code> 任务，回调 <code>SingleRequest.onResourceReady</code> ，并进行资源的引用+1；</li>
<li>执行 <code>decrementPendingCallbacks</code> 进行资源的引用-1；</li>
</ul>
<blockquote>
<p><code>Engine</code></p>
</blockquote>
<ul>
<li>将资源添加到 <code>activeResource</code> ;</li>
<li>移除当前<code>jobs</code> 中对应的 <code>EngineJob</code>;</li>
</ul>
<blockquote>
<p><code>SingleRequest</code></p>
</blockquote>
<ul>
<li>判断&amp;校验，获取资源；</li>
<li>进行 <code>target.onResourceReadt</code> 将资源加载到 <code>View</code> 上。 </li>
</ul>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>因为上一篇文章是 <a href="https://dandanlove.blog.csdn.net/article/details/103256724" target="_blank" rel="noopener">Android-Universal-Image-Loader源码分析</a>  ，所以这里主要是结合 <code>ImageLoader</code> 来和 <code>Glide</code> 进行比较。</p>
<blockquote>
<p>功能</p>
</blockquote>
<ol>
<li><code>Glide</code> 默认的网络请求和 <code>ImageLoader</code> 相同都是 <code>HttpUrlConnection</code>；</li>
<li><code>Glide</code> 和 <code>ImageLoader</code> 都可以添加自定义的网络请求比如 <code>OkHttp</code> ;</li>
<li><code>Glide</code> 和 <code>ImageLoader</code> 都支持在图片加载前获取图片的数据（图片的宽、高）。</li>
<li><code>Glide</code> 会根据请求时会根据当前 <code>context</code> 的声明周期进行 <code>Request</code> 的管理（粒度为 <code>Application</code> 和 <code>Activity</code>）。这个功能是 <code>ImageLoader</code> 不具备的，<code>ImageLoader</code> 只能停止一个请求，或者停止所有请求。</li>
<li><code>Glide</code> 和 <code>ImageLoader</code> 都具有加载默认图、加载失败备用图的功能。</li>
<li><code>Glide</code> 具备加载缩略图的功能，这个功能是 <code>ImageLoader</code> 不具备的。</li>
<li><code>Glide</code> 可以设置请求时候的优先级，虽然说这个请求优先级不是十分严格仅仅是指导来做请求的优化处理，但这个功能是 <code>ImageLoader</code> 不具备的。</li>
<li><code>Glide</code> 加载图片的数据可支持多种类型，<code>ImageLoader</code> 只支持 <code>String</code> 。</li>
<li><code>Glide</code> 和 <code>ImageLoader</code> 都可以自定义配置图片加载库使用的 <code>download</code> 、<code>decoder</code> 、<code>executor</code> 、<code>cache</code> 等，只不过 <code>Glide</code> 对自定义模块配置更加的方便以及粒度更细。</li>
</ol>
<blockquote>
<p>缓存</p>
</blockquote>
<ol>
<li><code>ImageLoader</code> 缓存的 <code>key</code> 只能根据图片地址进行处理生成。 <code>Glide</code> 的原始数据的磁盘缓存的 <code>Key</code> 是由 <code>url</code> 和 <code>signature</code> 组成，资源图片的缓存（磁盘缓存和内存缓存）的 <code>Key</code> 是由图片的（宽、高、资源类型、资源转换类型、资源解码类型、签名、<code>model</code> 以及 <code>option</code>）组成而且签名可以由我们自己的 <code>request</code> 进行设置。</li>
<li><code>Gilde</code> 可以进行请求时的设置跳过缓存，或者进行 <code>signature</code> 设置防止缓存失效问题。这个是 <code>ImageLoader</code> 不具备的功能。</li>
<li><code>Glide</code> 进行渐变处理的图片会被再次缓存，这个功能是 <code>ImageLoader</code> 不具备的。</li>
<li><code>Glide</code> 的内存缓存分为两级<code>MemoryCache</code> 和 <code>ActiveResource</code> ，<code>MemoryCache</code> 和 <code>ImageLoader</code> 相同都是使用 <code>LruCache</code> ，<code>ActiveResource</code> 对正在使用的图片做了弱引用，防止使用中的 <code>资源</code> 被 <code>LRU</code> 算法回收掉。</li>
</ol>
<p>文章到这里就全部讲述完啦，若有其他需要交流的可以留言哦~！~！</p>
<p>想阅读作者的更多文章，可以查看我的公共号：</p>
<center><img src="http://upload-images.jianshu.io/upload_images/1319879-612c4c66d40ce855.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="振兴书城"></center>
      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/weixinpay.jpeg" alt="振兴 微信支付"/>
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpeg" alt="振兴 支付宝"/>
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    振兴
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://yoursite.com/2019/12/20/glide/" title="Glide源码阅读理解一小时">http://yoursite.com/2019/12/20/glide/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Glide/" rel="tag"><i class="fa fa-tag"></i> Glide</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/11/26/AndroidUniversalImageLoader/" rel="next" title="Android-Universal-Image-Loader源码分析">
                <i class="fa fa-chevron-left"></i> Android-Universal-Image-Loader源码分析
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/12/30/picasso/" rel="prev" title="Picasso源码分析和对比">
                Picasso源码分析和对比 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      
        <div id="gitment-container"></div>
      
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/jay.jpg"
                alt="振兴" />
            
              <p class="site-author-name" itemprop="name">振兴</p>
              <p class="site-description motion-element" itemprop="description">好好学习，天天向上</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">77</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">97</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/stven0king" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://me.csdn.net/stven_king" target="_blank" title="CSDN">
                      
                        <i class="fa fa-fw fa-crosshairs"></i>CSDN</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.jianshu.com/u/311540b7592b" target="_blank" title="简书">
                      
                        <i class="fa fa-fw fa-book"></i>简书</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://juejin.im/user/56824a1900b01b9f2bd94ae8" target="_blank" title="掘金">
                      
                        <i class="fa fa-fw fa-spinner"></i>掘金</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://weibo.com/2520114671/profile?rightmod=1&wvr=6&mod=personinfo" target="_blank" title="微博">
                      
                        <i class="fa fa-fw fa-weibo"></i>微博</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:stven0king@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                推荐阅读
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://gityuan.com/" title="Gityuan" target="_blank">Gityuan</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.wanandroid.com/index" title="玩Android" target="_blank">玩Android</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.wjdiankong.cn/" title="尼古拉斯.赵四" target="_blank">尼古拉斯.赵四</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Glide介绍"><span class="nav-number">2.</span> <span class="nav-text">Glide介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#关于Glide"><span class="nav-number">2.1.</span> <span class="nav-text">关于Glide</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Glide性能"><span class="nav-number">2.2.</span> <span class="nav-text">Glide性能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GlideAPI"><span class="nav-number">2.3.</span> <span class="nav-text">GlideAPI</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Glide源码分析"><span class="nav-number">3.</span> <span class="nav-text">Glide源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Glide接入"><span class="nav-number">3.1.</span> <span class="nav-text">Glide接入</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Glide初始化"><span class="nav-number">3.2.</span> <span class="nav-text">Glide初始化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Glide和Engine构造"><span class="nav-number">3.3.</span> <span class="nav-text">Glide和Engine构造</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Register"><span class="nav-number">3.4.</span> <span class="nav-text">Register</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Encoder"><span class="nav-number">3.4.1.</span> <span class="nav-text">Encoder</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Decoder"><span class="nav-number">3.4.2.</span> <span class="nav-text">Decoder</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Transcoder"><span class="nav-number">3.4.3.</span> <span class="nav-text">Transcoder</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ModelLoader"><span class="nav-number">3.4.4.</span> <span class="nav-text">ModelLoader</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Transformation"><span class="nav-number">3.4.5.</span> <span class="nav-text">Transformation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DataRewinder"><span class="nav-number">3.4.6.</span> <span class="nav-text">DataRewinder</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Transition"><span class="nav-number">3.4.7.</span> <span class="nav-text">Transition</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Glide使用"><span class="nav-number">3.5.</span> <span class="nav-text">Glide使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RequestManager"><span class="nav-number">3.6.</span> <span class="nav-text">RequestManager</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#RequestManager的获取"><span class="nav-number">3.6.1.</span> <span class="nav-text">RequestManager的获取</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#其它功能"><span class="nav-number">3.6.2.</span> <span class="nav-text">其它功能</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Target"><span class="nav-number">3.7.</span> <span class="nav-text">Target</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RequestBuilder"><span class="nav-number">3.8.</span> <span class="nav-text">RequestBuilder</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ViewTarget的生成"><span class="nav-number">3.8.1.</span> <span class="nav-text">ViewTarget的生成</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Request"><span class="nav-number">3.9.</span> <span class="nav-text">Request</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Request的创建"><span class="nav-number">3.9.1.</span> <span class="nav-text">Request的创建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SingleRequest"><span class="nav-number">3.9.2.</span> <span class="nav-text">SingleRequest</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Request-begin"><span class="nav-number">3.9.3.</span> <span class="nav-text">Request.begin</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Engine-load"><span class="nav-number">3.10.</span> <span class="nav-text">Engine.load</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#内存缓存加载"><span class="nav-number">3.10.1.</span> <span class="nav-text">内存缓存加载</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ActiveResources"><span class="nav-number">3.10.1.1.</span> <span class="nav-text">ActiveResources</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MemoryCache"><span class="nav-number">3.10.1.2.</span> <span class="nav-text">MemoryCache</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DecodeJob"><span class="nav-number">3.10.2.</span> <span class="nav-text">DecodeJob</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#磁盘缓存加载"><span class="nav-number">3.10.3.</span> <span class="nav-text">磁盘缓存加载</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ResourceCacheGenerator"><span class="nav-number">3.10.3.1.</span> <span class="nav-text">ResourceCacheGenerator</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#DataCacheGenerator"><span class="nav-number">3.10.3.2.</span> <span class="nav-text">DataCacheGenerator</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#源数据请求"><span class="nav-number">3.10.4.</span> <span class="nav-text">源数据请求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数据解码和转码"><span class="nav-number">3.10.5.</span> <span class="nav-text">数据解码和转码</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#解码-amp-渐变-amp-转码"><span class="nav-number">3.10.5.1.</span> <span class="nav-text">解码&amp;渐变&amp;转码</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#加载-amp-释放资源"><span class="nav-number">3.10.6.</span> <span class="nav-text">加载&amp;释放资源</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#总结"><span class="nav-number">4.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">振兴</span>

  
</div>



<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
  本站总访问量<span id="busuanzi_value_site_pv"></span>次
</span>
</div>

  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>


<!--

  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>



-->
        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  







<!-- LOCAL: You can save these files to your site and update links -->
    
        
        <link rel="stylesheet" href="https://billts.site/extra_css/gitment.css">
        <script src="https://billts.site/js/gitment.js"></script>
    
<!-- END LOCAL -->

    

    
      <script type="text/javascript">
      function renderGitment(){
        var gitment = new Gitment({
            id: window.location.pathname, 
            owner: 'stven0king',
            repo: 'stven0king.github.io',
            
            oauth: {
            
            
                client_secret: '2206c556bf3e1f5967962220c3439f458ed41c7f',
            
                client_id: '00c12e7601ea8004b339'
            }});
        gitment.render('gitment-container');
      }

      
      renderGitment();
      
      </script>
    







  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
